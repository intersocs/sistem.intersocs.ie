{"version":3,"file":"index.cjs.js","sources":["../src/controllers/sw-types.ts","../src/models/errors.ts","../src/models/fcm-details.ts","../src/models/worker-page-message.ts","../src/helpers/is-array-buffer-equal.ts","../src/helpers/array-buffer-to-base64.ts","../src/models/iid-model.ts","../src/helpers/base64-to-array-buffer.ts","../src/models/clean-v1-undefined.ts","../src/models/db-interface.ts","../src/models/token-details-model.ts","../src/models/vapid-details-model.ts","../src/controllers/base-controller.ts","../src/controllers/sw-controller.ts","../src/models/default-sw.ts","../src/controllers/window-controller.ts","../index.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2018 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Subset of Web Worker types from lib.webworker.d.ts\n * https://github.com/Microsoft/TypeScript/blob/master/lib/lib.webworker.d.ts\n *\n * Since it's not possible to have both \"dom\" and \"webworker\" libs in a single\n * project, we have to manually declare the web worker types we need.\n */\n\n/* eslint-disable @typescript-eslint/no-explicit-any, These types are from TS */\n\n// Not the whole interface, just the parts we're currently using.\n// If TS claims that something does not exist on this, feel free to add it.\ninterface ServiceWorkerGlobalScope {\n  readonly location: WorkerLocation;\n  readonly clients: Clients;\n  readonly registration: ServiceWorkerRegistration;\n  addEventListener<K extends keyof ServiceWorkerGlobalScopeEventMap>(\n    type: K,\n    listener: (\n      this: ServiceWorkerGlobalScope,\n      ev: ServiceWorkerGlobalScopeEventMap[K]\n    ) => any,\n    options?: boolean | AddEventListenerOptions\n  ): void;\n}\n\n// Same as the previous interface\ninterface ServiceWorkerGlobalScopeEventMap {\n  notificationclick: NotificationEvent;\n  push: PushEvent;\n  pushsubscriptionchange: PushSubscriptionChangeEvent;\n}\n\ninterface Client {\n  readonly id: string;\n  readonly reserved: boolean;\n  readonly type: ClientTypes;\n  readonly url: string;\n  postMessage(message: any, transfer?: any[]): void;\n}\n\ninterface ClientQueryOptions {\n  includeReserved?: boolean;\n  includeUncontrolled?: boolean;\n  type?: ClientTypes;\n}\n\ninterface WindowClient extends Client {\n  readonly ancestorOrigins: readonly string[];\n  readonly focused: boolean;\n  readonly visibilityState: VisibilityState;\n  focus(): Promise<WindowClient>;\n  navigate(url: string): Promise<WindowClient>;\n}\n\ninterface Clients {\n  claim(): Promise<void>;\n  get(id: string): Promise<any>;\n  matchAll(options?: ClientQueryOptions): Promise<Client[]>;\n  openWindow(url: string): Promise<WindowClient | null>;\n}\n\ninterface ExtendableEvent extends Event {\n  waitUntil(f: Promise<any>): void;\n}\n\ninterface NotificationEvent extends ExtendableEvent {\n  readonly action: string;\n  readonly notification: Notification;\n}\n\ninterface PushMessageData {\n  arrayBuffer(): ArrayBuffer;\n  blob(): Blob;\n  json(): any;\n  text(): string;\n}\n\ninterface PushEvent extends ExtendableEvent {\n  readonly data: PushMessageData | null;\n}\n\ninterface PushSubscriptionChangeEvent extends ExtendableEvent {\n  readonly newSubscription: PushSubscription | null;\n  readonly oldSubscription: PushSubscription | null;\n}\n\ninterface WorkerLocation {\n  readonly hash: string;\n  readonly host: string;\n  readonly hostname: string;\n  readonly href: string;\n  readonly origin: string;\n  readonly pathname: string;\n  readonly port: string;\n  readonly protocol: string;\n  readonly search: string;\n  toString(): string;\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ErrorFactory, ErrorMap } from '@firebase/util';\n\nexport const enum ErrorCode {\n  AVAILABLE_IN_WINDOW = 'only-available-in-window',\n  AVAILABLE_IN_SW = 'only-available-in-sw',\n  SHOULD_BE_INHERITED = 'should-be-overriden',\n  BAD_SENDER_ID = 'bad-sender-id',\n  INCORRECT_GCM_SENDER_ID = 'incorrect-gcm-sender-id',\n  PERMISSION_DEFAULT = 'permission-default',\n  PERMISSION_BLOCKED = 'permission-blocked',\n  UNSUPPORTED_BROWSER = 'unsupported-browser',\n  NOTIFICATIONS_BLOCKED = 'notifications-blocked',\n  FAILED_DEFAULT_REGISTRATION = 'failed-serviceworker-registration',\n  SW_REGISTRATION_EXPECTED = 'sw-registration-expected',\n  GET_SUBSCRIPTION_FAILED = 'get-subscription-failed',\n  INVALID_SAVED_TOKEN = 'invalid-saved-token',\n  SW_REG_REDUNDANT = 'sw-reg-redundant',\n  TOKEN_SUBSCRIBE_FAILED = 'token-subscribe-failed',\n  TOKEN_SUBSCRIBE_NO_TOKEN = 'token-subscribe-no-token',\n  TOKEN_SUBSCRIBE_NO_PUSH_SET = 'token-subscribe-no-push-set',\n  TOKEN_UNSUBSCRIBE_FAILED = 'token-unsubscribe-failed',\n  TOKEN_UPDATE_FAILED = 'token-update-failed',\n  TOKEN_UPDATE_NO_TOKEN = 'token-update-no-token',\n  USE_SW_BEFORE_GET_TOKEN = 'use-sw-before-get-token',\n  INVALID_DELETE_TOKEN = 'invalid-delete-token',\n  DELETE_TOKEN_NOT_FOUND = 'delete-token-not-found',\n  DELETE_SCOPE_NOT_FOUND = 'delete-scope-not-found',\n  BG_HANDLER_FUNCTION_EXPECTED = 'bg-handler-function-expected',\n  NO_WINDOW_CLIENT_TO_MSG = 'no-window-client-to-msg',\n  UNABLE_TO_RESUBSCRIBE = 'unable-to-resubscribe',\n  NO_FCM_TOKEN_FOR_RESUBSCRIBE = 'no-fcm-token-for-resubscribe',\n  FAILED_TO_DELETE_TOKEN = 'failed-to-delete-token',\n  NO_SW_IN_REG = 'no-sw-in-reg',\n  BAD_SCOPE = 'bad-scope',\n  BAD_VAPID_KEY = 'bad-vapid-key',\n  BAD_SUBSCRIPTION = 'bad-subscription',\n  BAD_TOKEN = 'bad-token',\n  BAD_PUSH_SET = 'bad-push-set',\n  FAILED_DELETE_VAPID_KEY = 'failed-delete-vapid-key',\n  INVALID_PUBLIC_VAPID_KEY = 'invalid-public-vapid-key',\n  USE_PUBLIC_KEY_BEFORE_GET_TOKEN = 'use-public-key-before-get-token',\n  PUBLIC_KEY_DECRYPTION_FAILED = 'public-vapid-key-decryption-failed'\n}\n\nexport const ERROR_MAP: ErrorMap<ErrorCode> = {\n  [ErrorCode.AVAILABLE_IN_WINDOW]:\n    'This method is available in a Window context.',\n  [ErrorCode.AVAILABLE_IN_SW]:\n    'This method is available in a service worker context.',\n  [ErrorCode.SHOULD_BE_INHERITED]:\n    'This method should be overriden by extended classes.',\n  [ErrorCode.BAD_SENDER_ID]:\n    \"Please ensure that 'messagingSenderId' is set \" +\n    'correctly in the options passed into firebase.initializeApp().',\n  [ErrorCode.PERMISSION_DEFAULT]:\n    'The required permissions were not granted and dismissed instead.',\n  [ErrorCode.PERMISSION_BLOCKED]:\n    'The required permissions were not granted and blocked instead.',\n  [ErrorCode.UNSUPPORTED_BROWSER]:\n    \"This browser doesn't support the API's \" +\n    'required to use the firebase SDK.',\n  [ErrorCode.NOTIFICATIONS_BLOCKED]: 'Notifications have been blocked.',\n  [ErrorCode.FAILED_DEFAULT_REGISTRATION]:\n    'We are unable to register the ' +\n    'default service worker. {$browserErrorMessage}',\n  [ErrorCode.SW_REGISTRATION_EXPECTED]:\n    'A service worker registration was the expected input.',\n  [ErrorCode.GET_SUBSCRIPTION_FAILED]:\n    'There was an error when trying to get ' +\n    'any existing Push Subscriptions.',\n  [ErrorCode.INVALID_SAVED_TOKEN]:\n    'Unable to access details of the saved token.',\n  [ErrorCode.SW_REG_REDUNDANT]:\n    'The service worker being used for push was made redundant.',\n  [ErrorCode.TOKEN_SUBSCRIBE_FAILED]:\n    'A problem occured while subscribing the user to FCM: {$errorInfo}',\n  [ErrorCode.TOKEN_SUBSCRIBE_NO_TOKEN]:\n    'FCM returned no token when subscribing the user to push.',\n  [ErrorCode.TOKEN_SUBSCRIBE_NO_PUSH_SET]:\n    'FCM returned an invalid response when getting an FCM token.',\n  [ErrorCode.TOKEN_UNSUBSCRIBE_FAILED]:\n    'A problem occured while unsubscribing the ' +\n    'user from FCM: {$errorInfo}',\n  [ErrorCode.TOKEN_UPDATE_FAILED]:\n    'A problem occured while updating the user from FCM: {$errorInfo}',\n  [ErrorCode.TOKEN_UPDATE_NO_TOKEN]:\n    'FCM returned no token when updating the user to push.',\n  [ErrorCode.USE_SW_BEFORE_GET_TOKEN]:\n    'The useServiceWorker() method may only be called once and must be ' +\n    'called before calling getToken() to ensure your service worker is used.',\n  [ErrorCode.INVALID_DELETE_TOKEN]:\n    'You must pass a valid token into ' +\n    'deleteToken(), i.e. the token from getToken().',\n  [ErrorCode.DELETE_TOKEN_NOT_FOUND]:\n    'The deletion attempt for token could not ' +\n    'be performed as the token was not found.',\n  [ErrorCode.DELETE_SCOPE_NOT_FOUND]:\n    'The deletion attempt for service worker ' +\n    'scope could not be performed as the scope was not found.',\n  [ErrorCode.BG_HANDLER_FUNCTION_EXPECTED]:\n    'The input to setBackgroundMessageHandler() must be a function.',\n  [ErrorCode.NO_WINDOW_CLIENT_TO_MSG]:\n    'An attempt was made to message a non-existant window client.',\n  [ErrorCode.UNABLE_TO_RESUBSCRIBE]:\n    'There was an error while re-subscribing ' +\n    'the FCM token for push messaging. Will have to resubscribe the ' +\n    'user on next visit. {$errorInfo}',\n  [ErrorCode.NO_FCM_TOKEN_FOR_RESUBSCRIBE]:\n    'Could not find an FCM token ' +\n    'and as a result, unable to resubscribe. Will have to resubscribe the ' +\n    'user on next visit.',\n  [ErrorCode.FAILED_TO_DELETE_TOKEN]:\n    'Unable to delete the currently saved token.',\n  [ErrorCode.NO_SW_IN_REG]:\n    'Even though the service worker registration was ' +\n    'successful, there was a problem accessing the service worker itself.',\n  [ErrorCode.INCORRECT_GCM_SENDER_ID]:\n    \"Please change your web app manifest's \" +\n    \"'gcm_sender_id' value to '103953800507' to use Firebase messaging.\",\n  [ErrorCode.BAD_SCOPE]:\n    'The service worker scope must be a string with at ' +\n    'least one character.',\n  [ErrorCode.BAD_VAPID_KEY]:\n    'The public VAPID key is not a Uint8Array with 65 bytes.',\n  [ErrorCode.BAD_SUBSCRIPTION]:\n    'The subscription must be a valid PushSubscription.',\n  [ErrorCode.BAD_TOKEN]:\n    'The FCM Token used for storage / lookup was not ' +\n    'a valid token string.',\n  [ErrorCode.BAD_PUSH_SET]:\n    'The FCM push set used for storage / lookup was not ' +\n    'not a valid push set string.',\n  [ErrorCode.FAILED_DELETE_VAPID_KEY]: 'The VAPID key could not be deleted.',\n  [ErrorCode.INVALID_PUBLIC_VAPID_KEY]:\n    'The public VAPID key must be a string.',\n  [ErrorCode.USE_PUBLIC_KEY_BEFORE_GET_TOKEN]:\n    'The usePublicVapidKey() method may only be called once and must be ' +\n    'called before calling getToken() to ensure your VAPID key is used.',\n  [ErrorCode.PUBLIC_KEY_DECRYPTION_FAILED]:\n    'The public VAPID key did not equal 65 bytes when decrypted.'\n};\n\ninterface ErrorParams {\n  [ErrorCode.FAILED_DEFAULT_REGISTRATION]: { browserErrorMessage: string };\n  [ErrorCode.TOKEN_SUBSCRIBE_FAILED]: { errorInfo: string };\n  [ErrorCode.TOKEN_UNSUBSCRIBE_FAILED]: { errorInfo: string };\n  [ErrorCode.TOKEN_UPDATE_FAILED]: { errorInfo: string };\n  [ErrorCode.UNABLE_TO_RESUBSCRIBE]: { errorInfo: string };\n}\n\nexport const errorFactory = new ErrorFactory<ErrorCode, ErrorParams>(\n  'messaging',\n  'Messaging',\n  ERROR_MAP\n);\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport const DEFAULT_PUBLIC_VAPID_KEY = new Uint8Array([\n  0x04,\n  0x33,\n  0x94,\n  0xf7,\n  0xdf,\n  0xa1,\n  0xeb,\n  0xb1,\n  0xdc,\n  0x03,\n  0xa2,\n  0x5e,\n  0x15,\n  0x71,\n  0xdb,\n  0x48,\n  0xd3,\n  0x2e,\n  0xed,\n  0xed,\n  0xb2,\n  0x34,\n  0xdb,\n  0xb7,\n  0x47,\n  0x3a,\n  0x0c,\n  0x8f,\n  0xc4,\n  0xcc,\n  0xe1,\n  0x6f,\n  0x3c,\n  0x8c,\n  0x84,\n  0xdf,\n  0xab,\n  0xb6,\n  0x66,\n  0x3e,\n  0xf2,\n  0x0c,\n  0xd4,\n  0x8b,\n  0xfe,\n  0xe3,\n  0xf9,\n  0x76,\n  0x2f,\n  0x14,\n  0x1c,\n  0x63,\n  0x08,\n  0x6a,\n  0x6f,\n  0x2d,\n  0xb1,\n  0x1a,\n  0x95,\n  0xb0,\n  0xce,\n  0x37,\n  0xc0,\n  0x9c,\n  0x6e\n]);\n\nexport const SUBSCRIPTION_DETAILS = {\n  userVisibleOnly: true,\n  applicationServerKey: DEFAULT_PUBLIC_VAPID_KEY\n};\n\nexport const ENDPOINT = 'https://fcm.googleapis.com';\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { MessagePayload } from '../interfaces/message-payload';\n\nexport enum MessageParameter {\n  TYPE_OF_MSG = 'firebase-messaging-msg-type',\n  DATA = 'firebase-messaging-msg-data'\n}\n\nexport enum MessageType {\n  PUSH_MSG_RECEIVED = 'push-msg-received',\n  NOTIFICATION_CLICKED = 'notification-clicked'\n}\n\nexport interface InternalMessage {\n  [MessageParameter.TYPE_OF_MSG]: MessageType;\n  [MessageParameter.DATA]: MessagePayload;\n}\n","/**\n * @license\n * Copyright 2018 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport function isArrayBufferEqual(\n  a: ArrayBufferLike | undefined | null,\n  b: ArrayBufferLike | undefined | null\n): boolean {\n  if (a == null || b == null) {\n    return false;\n  }\n\n  if (a === b) {\n    return true;\n  }\n\n  if (a.byteLength !== b.byteLength) {\n    return false;\n  }\n\n  const viewA = new DataView(a);\n  const viewB = new DataView(b);\n\n  for (let i = 0; i < a.byteLength; i++) {\n    if (viewA.getUint8(i) !== viewB.getUint8(i)) {\n      return false;\n    }\n  }\n\n  return true;\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nfunction toBase64(arrayBuffer: ArrayBuffer | Uint8Array): string {\n  const uint8Version = new Uint8Array(arrayBuffer);\n  return btoa(String.fromCharCode(...uint8Version));\n}\n\nexport function arrayBufferToBase64(\n  arrayBuffer: ArrayBuffer | Uint8Array\n): string {\n  const base64String = toBase64(arrayBuffer);\n  return base64String\n    .replace(/=/g, '')\n    .replace(/\\+/g, '-')\n    .replace(/\\//g, '_');\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { arrayBufferToBase64 } from '../helpers/array-buffer-to-base64';\nimport { isArrayBufferEqual } from '../helpers/is-array-buffer-equal';\nimport { ErrorCode, errorFactory } from './errors';\nimport { DEFAULT_PUBLIC_VAPID_KEY, ENDPOINT } from './fcm-details';\n\nexport interface IidDetails {\n  token: string;\n  pushSet: string;\n}\n\ninterface ApiResponse extends Partial<IidDetails> {\n  error?: { message: string };\n}\n\nexport class IidModel {\n  async getToken(\n    senderId: string,\n    subscription: PushSubscription,\n    publicVapidKey: Uint8Array\n  ): Promise<IidDetails> {\n    const p256dh = arrayBufferToBase64(subscription.getKey('p256dh')!);\n    const auth = arrayBufferToBase64(subscription.getKey('auth')!);\n\n    let fcmSubscribeBody =\n      `authorized_entity=${senderId}&` +\n      `endpoint=${subscription.endpoint}&` +\n      `encryption_key=${p256dh}&` +\n      `encryption_auth=${auth}`;\n\n    if (\n      !isArrayBufferEqual(\n        publicVapidKey.buffer,\n        DEFAULT_PUBLIC_VAPID_KEY.buffer\n      )\n    ) {\n      const applicationPubKey = arrayBufferToBase64(publicVapidKey);\n      fcmSubscribeBody += `&application_pub_key=${applicationPubKey}`;\n    }\n\n    const headers = new Headers();\n    headers.append('Content-Type', 'application/x-www-form-urlencoded');\n\n    const subscribeOptions = {\n      method: 'POST',\n      headers,\n      body: fcmSubscribeBody\n    };\n\n    let responseData: ApiResponse;\n    try {\n      const response = await fetch(\n        ENDPOINT + '/fcm/connect/subscribe',\n        subscribeOptions\n      );\n\n      responseData = await response.json();\n    } catch (err) {\n      throw errorFactory.create(ErrorCode.TOKEN_SUBSCRIBE_FAILED, {\n        errorInfo: err\n      });\n    }\n\n    if (responseData.error) {\n      const message = responseData.error.message;\n      throw errorFactory.create(ErrorCode.TOKEN_SUBSCRIBE_FAILED, {\n        errorInfo: message\n      });\n    }\n\n    if (!responseData.token) {\n      throw errorFactory.create(ErrorCode.TOKEN_SUBSCRIBE_NO_TOKEN);\n    }\n\n    if (!responseData.pushSet) {\n      throw errorFactory.create(ErrorCode.TOKEN_SUBSCRIBE_NO_PUSH_SET);\n    }\n\n    return {\n      token: responseData.token,\n      pushSet: responseData.pushSet\n    };\n  }\n\n  /**\n   * Update the underlying token details for fcmToken.\n   */\n  async updateToken(\n    senderId: string,\n    fcmToken: string,\n    fcmPushSet: string,\n    subscription: PushSubscription,\n    publicVapidKey: Uint8Array\n  ): Promise<string> {\n    const p256dh = arrayBufferToBase64(subscription.getKey('p256dh')!);\n    const auth = arrayBufferToBase64(subscription.getKey('auth')!);\n\n    let fcmUpdateBody =\n      `push_set=${fcmPushSet}&` +\n      `token=${fcmToken}&` +\n      `authorized_entity=${senderId}&` +\n      `endpoint=${subscription.endpoint}&` +\n      `encryption_key=${p256dh}&` +\n      `encryption_auth=${auth}`;\n\n    if (\n      !isArrayBufferEqual(\n        publicVapidKey.buffer,\n        DEFAULT_PUBLIC_VAPID_KEY.buffer\n      )\n    ) {\n      const applicationPubKey = arrayBufferToBase64(publicVapidKey);\n      fcmUpdateBody += `&application_pub_key=${applicationPubKey}`;\n    }\n\n    const headers = new Headers();\n    headers.append('Content-Type', 'application/x-www-form-urlencoded');\n\n    const updateOptions = {\n      method: 'POST',\n      headers,\n      body: fcmUpdateBody\n    };\n\n    let responseData: ApiResponse;\n    try {\n      const response = await fetch(\n        ENDPOINT + '/fcm/connect/subscribe',\n        updateOptions\n      );\n      responseData = await response.json();\n    } catch (err) {\n      throw errorFactory.create(ErrorCode.TOKEN_UPDATE_FAILED, {\n        errorInfo: err\n      });\n    }\n\n    if (responseData.error) {\n      const message = responseData.error.message;\n      throw errorFactory.create(ErrorCode.TOKEN_UPDATE_FAILED, {\n        errorInfo: message\n      });\n    }\n\n    if (!responseData.token) {\n      throw errorFactory.create(ErrorCode.TOKEN_UPDATE_NO_TOKEN);\n    }\n\n    return responseData.token;\n  }\n\n  /**\n   * Given a fcmToken, pushSet and messagingSenderId, delete an FCM token.\n   */\n  async deleteToken(\n    senderId: string,\n    fcmToken: string,\n    fcmPushSet: string\n  ): Promise<void> {\n    const fcmUnsubscribeBody =\n      `authorized_entity=${senderId}&` +\n      `token=${fcmToken}&` +\n      `pushSet=${fcmPushSet}`;\n\n    const headers = new Headers();\n    headers.append('Content-Type', 'application/x-www-form-urlencoded');\n\n    const unsubscribeOptions = {\n      method: 'POST',\n      headers,\n      body: fcmUnsubscribeBody\n    };\n\n    try {\n      const response = await fetch(\n        ENDPOINT + '/fcm/connect/unsubscribe',\n        unsubscribeOptions\n      );\n      const responseData: ApiResponse = await response.json();\n      if (responseData.error) {\n        const message = responseData.error.message;\n        throw errorFactory.create(ErrorCode.TOKEN_UNSUBSCRIBE_FAILED, {\n          errorInfo: message\n        });\n      }\n    } catch (err) {\n      throw errorFactory.create(ErrorCode.TOKEN_UNSUBSCRIBE_FAILED, {\n        errorInfo: err\n      });\n    }\n  }\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport function base64ToArrayBuffer(base64String: string): Uint8Array {\n  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);\n  const base64 = (base64String + padding)\n    .replace(/\\-/g, '+')\n    .replace(/_/g, '/');\n\n  const rawData = atob(base64);\n  const outputArray = new Uint8Array(rawData.length);\n\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i);\n  }\n  return outputArray;\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * There seems to have been a bug in the messaging SDK versions <= 4.9.x\n * where the IndexedDB model was using a database name of 'undefined'.\n *\n * In 4.10.x we changed the model implementation, but kept the database\n * name as it should have been. This however introduced an issue where\n * two tokens were pointing to the same underlying PushSubscription.\n *\n * This code will look for the undefined database and delete any of the\n * underlying tokens.\n */\n\nimport { IidModel } from '../models/iid-model';\n\nconst OLD_DB_NAME = 'undefined';\nconst OLD_OBJECT_STORE_NAME = 'fcm_token_object_Store';\n\nfunction handleDb(db: IDBDatabase): void {\n  if (!db.objectStoreNames.contains(OLD_OBJECT_STORE_NAME)) {\n    // We found a database with the name 'undefined', but our expected object\n    // store isn't defined.\n    return;\n  }\n\n  const transaction = db.transaction(OLD_OBJECT_STORE_NAME);\n  const objectStore = transaction.objectStore(OLD_OBJECT_STORE_NAME);\n\n  const iidModel = new IidModel();\n\n  const openCursorRequest: IDBRequest = objectStore.openCursor();\n  openCursorRequest.onerror = event => {\n    // NOOP - Nothing we can do.\n    console.warn('Unable to cleanup old IDB.', event);\n  };\n\n  openCursorRequest.onsuccess = () => {\n    const cursor = openCursorRequest.result;\n    if (cursor) {\n      // cursor.value contains the current record being iterated through\n      // this is where you'd do something with the result\n      const tokenDetails = cursor.value;\n\n      // tslint:disable-next-line:no-floating-promises\n      iidModel.deleteToken(\n        tokenDetails.fcmSenderId,\n        tokenDetails.fcmToken,\n        tokenDetails.fcmPushSet\n      );\n\n      cursor.continue();\n    } else {\n      db.close();\n      indexedDB.deleteDatabase(OLD_DB_NAME);\n    }\n  };\n}\n\nexport function cleanV1(): void {\n  const request: IDBOpenDBRequest = indexedDB.open(OLD_DB_NAME);\n  request.onerror = _event => {\n    // NOOP - Nothing we can do.\n  };\n  request.onsuccess = _event => {\n    const db = request.result;\n    handleDb(db);\n  };\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport abstract class DbInterface {\n  private dbPromise: Promise<IDBDatabase> | null = null;\n\n  protected abstract readonly dbName: string;\n  protected abstract readonly dbVersion: number;\n  protected abstract readonly objectStoreName: string;\n\n  /**\n   * Database initialization.\n   *\n   * This function should create and update object stores.\n   */\n  protected abstract onDbUpgrade(\n    request: IDBOpenDBRequest,\n    event: IDBVersionChangeEvent\n  ): void;\n\n  /** Gets record(s) from the objectStore that match the given key. */\n  get<T>(key: IDBValidKey): Promise<T | undefined> {\n    return this.createTransaction(objectStore => objectStore.get(key));\n  }\n\n  /** Gets record(s) from the objectStore that match the given index. */\n  getIndex<T>(index: string, key: IDBValidKey): Promise<T | undefined> {\n    function runRequest(objectStore: IDBObjectStore): IDBRequest {\n      const idbIndex = objectStore.index(index);\n      return idbIndex.get(key);\n    }\n\n    return this.createTransaction(runRequest);\n  }\n\n  /** Assigns or overwrites the record for the given value. */\n  // IndexedDB values are of type \"any\"\n  put(value: unknown): Promise<void> {\n    return this.createTransaction(\n      objectStore => objectStore.put(value),\n      'readwrite'\n    );\n  }\n\n  /** Deletes record(s) from the objectStore that match the given key. */\n  delete(key: IDBValidKey | IDBKeyRange): Promise<void> {\n    return this.createTransaction(\n      objectStore => objectStore.delete(key),\n      'readwrite'\n    );\n  }\n\n  /**\n   * Close the currently open database.\n   */\n  async closeDatabase(): Promise<void> {\n    if (this.dbPromise) {\n      const db = await this.dbPromise;\n      db.close();\n      this.dbPromise = null;\n    }\n  }\n\n  /**\n   * Creates an IndexedDB Transaction and passes its objectStore to the\n   * runRequest function, which runs the database request.\n   *\n   * @return Promise that resolves with the result of the runRequest function\n   */\n  private async createTransaction<T>(\n    runRequest: (objectStore: IDBObjectStore) => IDBRequest,\n    mode: 'readonly' | 'readwrite' = 'readonly'\n  ): Promise<T> {\n    const db = await this.getDb();\n    const transaction = db.transaction(this.objectStoreName, mode);\n    const request = transaction.objectStore(this.objectStoreName);\n    const result = await promisify<T>(runRequest(request));\n\n    return new Promise<T>((resolve, reject) => {\n      transaction.oncomplete = () => {\n        resolve(result);\n      };\n      transaction.onerror = () => {\n        reject(transaction.error);\n      };\n    });\n  }\n\n  /** Gets the cached db connection or opens a new one. */\n  private getDb(): Promise<IDBDatabase> {\n    if (!this.dbPromise) {\n      this.dbPromise = new Promise<IDBDatabase>((resolve, reject) => {\n        const request = indexedDB.open(this.dbName, this.dbVersion);\n        request.onsuccess = () => {\n          resolve(request.result);\n        };\n        request.onerror = () => {\n          this.dbPromise = null;\n          reject(request.error);\n        };\n        request.onupgradeneeded = event => this.onDbUpgrade(request, event);\n      });\n    }\n\n    return this.dbPromise;\n  }\n}\n\n/** Promisifies an IDBRequest. Resolves with the IDBRequest's result. */\nfunction promisify<T>(request: IDBRequest): Promise<T> {\n  return new Promise<T>((resolve, reject) => {\n    request.onsuccess = () => {\n      resolve(request.result);\n    };\n    request.onerror = () => {\n      reject(request.error);\n    };\n  });\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { base64ToArrayBuffer } from '../helpers/base64-to-array-buffer';\nimport { TokenDetails } from '../interfaces/token-details';\nimport { cleanV1 } from './clean-v1-undefined';\nimport { DbInterface } from './db-interface';\nimport { ErrorCode, errorFactory } from './errors';\n\nexport class TokenDetailsModel extends DbInterface {\n  protected readonly dbName: string = 'fcm_token_details_db';\n  protected readonly dbVersion: number = 3;\n  protected readonly objectStoreName: string = 'fcm_token_object_Store';\n\n  protected onDbUpgrade(\n    request: IDBOpenDBRequest,\n    event: IDBVersionChangeEvent\n  ): void {\n    const db: IDBDatabase = request.result;\n\n    // Lack of 'break' statements is intentional.\n    switch (event.oldVersion) {\n      case 0: {\n        // New IDB instance\n        const objectStore = db.createObjectStore(this.objectStoreName, {\n          keyPath: 'swScope'\n        });\n\n        // Make sure the sender ID can be searched\n        objectStore.createIndex('fcmSenderId', 'fcmSenderId', {\n          unique: false\n        });\n\n        objectStore.createIndex('fcmToken', 'fcmToken', { unique: true });\n      }\n\n      case 1: {\n        // Prior to version 2, we were using either 'fcm_token_details_db'\n        // or 'undefined' as the database name due to bug in the SDK\n        // So remove the old tokens and databases.\n        cleanV1();\n      }\n\n      case 2: {\n        const objectStore = request.transaction!.objectStore(\n          this.objectStoreName\n        );\n        const cursorRequest = objectStore.openCursor();\n        cursorRequest.onsuccess = () => {\n          const cursor: IDBCursorWithValue | null = cursorRequest.result;\n          if (cursor) {\n            const value = cursor.value;\n            const newValue: Partial<TokenDetails> = { ...value };\n\n            if (!value.createTime) {\n              newValue.createTime = Date.now();\n            }\n\n            if (typeof value.vapidKey === 'string') {\n              newValue.vapidKey = base64ToArrayBuffer(value.vapidKey);\n            }\n\n            if (typeof value.auth === 'string') {\n              newValue.auth = base64ToArrayBuffer(value.auth).buffer;\n            }\n\n            if (typeof value.auth === 'string') {\n              newValue.p256dh = base64ToArrayBuffer(value.p256dh).buffer;\n            }\n\n            cursor.update(newValue);\n            cursor.continue();\n          }\n        };\n      }\n\n      default: // ignore\n    }\n  }\n\n  /**\n   * Given a token, this method will look up the details in indexedDB.\n   */\n  async getTokenDetailsFromToken(\n    fcmToken: string\n  ): Promise<TokenDetails | undefined> {\n    if (!fcmToken) {\n      throw errorFactory.create(ErrorCode.BAD_TOKEN);\n    }\n\n    validateInputs({ fcmToken });\n\n    return this.getIndex<TokenDetails>('fcmToken', fcmToken);\n  }\n\n  /**\n   * Given a service worker scope, this method will look up the details in\n   * indexedDB.\n   * @return The details associated with that token.\n   */\n  async getTokenDetailsFromSWScope(\n    swScope: string\n  ): Promise<TokenDetails | undefined> {\n    if (!swScope) {\n      throw errorFactory.create(ErrorCode.BAD_SCOPE);\n    }\n\n    validateInputs({ swScope });\n\n    return this.get<TokenDetails>(swScope);\n  }\n\n  /**\n   * Save the details for the fcm token for re-use at a later date.\n   * @param input A plain js object containing args to save.\n   */\n  async saveTokenDetails(tokenDetails: TokenDetails): Promise<void> {\n    if (!tokenDetails.swScope) {\n      throw errorFactory.create(ErrorCode.BAD_SCOPE);\n    }\n\n    if (!tokenDetails.vapidKey) {\n      throw errorFactory.create(ErrorCode.BAD_VAPID_KEY);\n    }\n\n    if (!tokenDetails.endpoint || !tokenDetails.auth || !tokenDetails.p256dh) {\n      throw errorFactory.create(ErrorCode.BAD_SUBSCRIPTION);\n    }\n\n    if (!tokenDetails.fcmSenderId) {\n      throw errorFactory.create(ErrorCode.BAD_SENDER_ID);\n    }\n\n    if (!tokenDetails.fcmToken) {\n      throw errorFactory.create(ErrorCode.BAD_TOKEN);\n    }\n\n    if (!tokenDetails.fcmPushSet) {\n      throw errorFactory.create(ErrorCode.BAD_PUSH_SET);\n    }\n\n    validateInputs(tokenDetails);\n\n    return this.put(tokenDetails);\n  }\n\n  /**\n   * This method deletes details of the current FCM token.\n   * It's returning a promise in case we need to move to an async\n   * method for deleting at a later date.\n   *\n   * @return Resolves once the FCM token details have been deleted and returns\n   * the deleted details.\n   */\n  async deleteToken(token: string): Promise<TokenDetails> {\n    if (typeof token !== 'string' || token.length === 0) {\n      return Promise.reject(\n        errorFactory.create(ErrorCode.INVALID_DELETE_TOKEN)\n      );\n    }\n\n    const details = await this.getTokenDetailsFromToken(token);\n    if (!details) {\n      throw errorFactory.create(ErrorCode.DELETE_TOKEN_NOT_FOUND);\n    }\n\n    await this.delete(details.swScope);\n    return details;\n  }\n}\n\n/**\n * This method takes an object and will check for known arguments and\n * validate the input.\n * @return Promise that resolves if input is valid, rejects otherwise.\n */\nfunction validateInputs(input: Partial<TokenDetails>): void {\n  if (input.fcmToken) {\n    if (typeof input.fcmToken !== 'string' || input.fcmToken.length === 0) {\n      throw errorFactory.create(ErrorCode.BAD_TOKEN);\n    }\n  }\n\n  if (input.swScope) {\n    if (typeof input.swScope !== 'string' || input.swScope.length === 0) {\n      throw errorFactory.create(ErrorCode.BAD_SCOPE);\n    }\n  }\n\n  if (input.vapidKey) {\n    if (\n      !(input.vapidKey instanceof Uint8Array) ||\n      input.vapidKey.length !== 65\n    ) {\n      throw errorFactory.create(ErrorCode.BAD_VAPID_KEY);\n    }\n  }\n\n  if (input.endpoint) {\n    if (typeof input.endpoint !== 'string' || input.endpoint.length === 0) {\n      throw errorFactory.create(ErrorCode.BAD_SUBSCRIPTION);\n    }\n  }\n\n  if (input.auth) {\n    if (!(input.auth instanceof ArrayBuffer)) {\n      throw errorFactory.create(ErrorCode.BAD_SUBSCRIPTION);\n    }\n  }\n\n  if (input.p256dh) {\n    if (!(input.p256dh instanceof ArrayBuffer)) {\n      throw errorFactory.create(ErrorCode.BAD_SUBSCRIPTION);\n    }\n  }\n\n  if (input.fcmSenderId) {\n    if (\n      typeof input.fcmSenderId !== 'string' ||\n      input.fcmSenderId.length === 0\n    ) {\n      throw errorFactory.create(ErrorCode.BAD_SENDER_ID);\n    }\n  }\n\n  if (input.fcmPushSet) {\n    if (typeof input.fcmPushSet !== 'string' || input.fcmPushSet.length === 0) {\n      throw errorFactory.create(ErrorCode.BAD_PUSH_SET);\n    }\n  }\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { VapidDetails } from '../interfaces/vapid-details';\nimport { DbInterface } from './db-interface';\nimport { ErrorCode, errorFactory } from './errors';\n\nconst UNCOMPRESSED_PUBLIC_KEY_SIZE = 65;\n\nexport class VapidDetailsModel extends DbInterface {\n  protected readonly dbName: string = 'fcm_vapid_details_db';\n  protected readonly dbVersion: number = 1;\n  protected readonly objectStoreName: string = 'fcm_vapid_object_Store';\n\n  protected onDbUpgrade(request: IDBOpenDBRequest): void {\n    const db: IDBDatabase = request.result;\n    db.createObjectStore(this.objectStoreName, { keyPath: 'swScope' });\n  }\n\n  /**\n   * Given a service worker scope, this method will look up the vapid key\n   * in indexedDB.\n   */\n  async getVapidFromSWScope(swScope: string): Promise<Uint8Array | undefined> {\n    if (typeof swScope !== 'string' || swScope.length === 0) {\n      throw errorFactory.create(ErrorCode.BAD_SCOPE);\n    }\n\n    const result = await this.get<VapidDetails>(swScope);\n    return result ? result.vapidKey : undefined;\n  }\n\n  /**\n   * Save a vapid key against a swScope for later date.\n   */\n  async saveVapidDetails(swScope: string, vapidKey: Uint8Array): Promise<void> {\n    if (typeof swScope !== 'string' || swScope.length === 0) {\n      throw errorFactory.create(ErrorCode.BAD_SCOPE);\n    }\n\n    if (vapidKey === null || vapidKey.length !== UNCOMPRESSED_PUBLIC_KEY_SIZE) {\n      throw errorFactory.create(ErrorCode.BAD_VAPID_KEY);\n    }\n\n    const details: VapidDetails = {\n      swScope,\n      vapidKey\n    };\n\n    return this.put(details);\n  }\n\n  /**\n   * This method deletes details of the current FCM VAPID key for a SW scope.\n   * Resolves once the scope/vapid details have been deleted and returns the\n   * deleted vapid key.\n   */\n  async deleteVapidDetails(swScope: string): Promise<Uint8Array> {\n    const vapidKey = await this.getVapidFromSWScope(swScope);\n    if (!vapidKey) {\n      throw errorFactory.create(ErrorCode.DELETE_SCOPE_NOT_FOUND);\n    }\n\n    await this.delete(swScope);\n    return vapidKey;\n  }\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FirebaseApp } from '@firebase/app-types';\nimport { FirebaseServiceInternals } from '@firebase/app-types/private';\nimport { FirebaseMessaging } from '@firebase/messaging-types';\nimport {\n  CompleteFn,\n  ErrorFn,\n  NextFn,\n  Observer,\n  Unsubscribe\n} from '@firebase/util';\n\nimport { isArrayBufferEqual } from '../helpers/is-array-buffer-equal';\nimport { MessagePayload } from '../interfaces/message-payload';\nimport { TokenDetails } from '../interfaces/token-details';\nimport { ErrorCode, errorFactory } from '../models/errors';\nimport { IidModel } from '../models/iid-model';\nimport { TokenDetailsModel } from '../models/token-details-model';\nimport { VapidDetailsModel } from '../models/vapid-details-model';\n\nexport type BgMessageHandler = (\n  payload: MessagePayload\n) => Promise<unknown> | void;\n\nconst SENDER_ID_OPTION_NAME = 'messagingSenderId';\n// Database cache should be invalidated once a week.\nexport const TOKEN_EXPIRATION_MILLIS = 7 * 24 * 60 * 60 * 1000; // 7 days\n\nexport abstract class BaseController implements FirebaseMessaging {\n  app: FirebaseApp;\n  INTERNAL: FirebaseServiceInternals;\n  private readonly messagingSenderId: string;\n  private readonly tokenDetailsModel: TokenDetailsModel;\n  private readonly vapidDetailsModel: VapidDetailsModel;\n  private readonly iidModel: IidModel;\n\n  /**\n   * An interface of the Messaging Service API\n   */\n  constructor(app: FirebaseApp) {\n    if (\n      !app.options[SENDER_ID_OPTION_NAME] ||\n      typeof app.options[SENDER_ID_OPTION_NAME] !== 'string'\n    ) {\n      throw errorFactory.create(ErrorCode.BAD_SENDER_ID);\n    }\n\n    this.messagingSenderId = app.options[SENDER_ID_OPTION_NAME]!;\n\n    this.tokenDetailsModel = new TokenDetailsModel();\n    this.vapidDetailsModel = new VapidDetailsModel();\n    this.iidModel = new IidModel();\n\n    this.app = app;\n    this.INTERNAL = {\n      delete: () => this.delete()\n    };\n  }\n\n  /**\n   * @export\n   */\n  async getToken(): Promise<string | null> {\n    // Check with permissions\n    const currentPermission = this.getNotificationPermission_();\n    if (currentPermission === 'denied') {\n      throw errorFactory.create(ErrorCode.NOTIFICATIONS_BLOCKED);\n    } else if (currentPermission !== 'granted') {\n      // We must wait for permission to be granted\n      return null;\n    }\n\n    const swReg = await this.getSWRegistration_();\n    const publicVapidKey = await this.getPublicVapidKey_();\n    // If a PushSubscription exists it's returned, otherwise a new subscription\n    // is generated and returned.\n    const pushSubscription = await this.getPushSubscription(\n      swReg,\n      publicVapidKey\n    );\n    const tokenDetails = await this.tokenDetailsModel.getTokenDetailsFromSWScope(\n      swReg.scope\n    );\n\n    if (tokenDetails) {\n      return this.manageExistingToken(\n        swReg,\n        pushSubscription,\n        publicVapidKey,\n        tokenDetails\n      );\n    }\n    return this.getNewToken(swReg, pushSubscription, publicVapidKey);\n  }\n\n  /**\n   * manageExistingToken is triggered if there's an existing FCM token in the\n   * database and it can take 3 different actions:\n   * 1) Retrieve the existing FCM token from the database.\n   * 2) If VAPID details have changed: Delete the existing token and create a\n   * new one with the new VAPID key.\n   * 3) If the database cache is invalidated: Send a request to FCM to update\n   * the token, and to check if the token is still valid on FCM-side.\n   */\n  private async manageExistingToken(\n    swReg: ServiceWorkerRegistration,\n    pushSubscription: PushSubscription,\n    publicVapidKey: Uint8Array,\n    tokenDetails: TokenDetails\n  ): Promise<string> {\n    const isTokenValid = isTokenStillValid(\n      pushSubscription,\n      publicVapidKey,\n      tokenDetails\n    );\n    if (isTokenValid) {\n      const now = Date.now();\n      if (now < tokenDetails.createTime + TOKEN_EXPIRATION_MILLIS) {\n        return tokenDetails.fcmToken;\n      } else {\n        return this.updateToken(\n          swReg,\n          pushSubscription,\n          publicVapidKey,\n          tokenDetails\n        );\n      }\n    }\n\n    // If the token is no longer valid (for example if the VAPID details\n    // have changed), delete the existing token from the FCM client and server\n    // database. No need to unsubscribe from the Service Worker as we have a\n    // good push subscription that we'd like to use in getNewToken.\n    await this.deleteTokenFromDB(tokenDetails.fcmToken);\n    return this.getNewToken(swReg, pushSubscription, publicVapidKey);\n  }\n\n  private async updateToken(\n    swReg: ServiceWorkerRegistration,\n    pushSubscription: PushSubscription,\n    publicVapidKey: Uint8Array,\n    tokenDetails: TokenDetails\n  ): Promise<string> {\n    try {\n      const updatedToken = await this.iidModel.updateToken(\n        this.messagingSenderId,\n        tokenDetails.fcmToken,\n        tokenDetails.fcmPushSet,\n        pushSubscription,\n        publicVapidKey\n      );\n\n      const allDetails: TokenDetails = {\n        swScope: swReg.scope,\n        vapidKey: publicVapidKey,\n        fcmSenderId: this.messagingSenderId,\n        fcmToken: updatedToken,\n        fcmPushSet: tokenDetails.fcmPushSet,\n        createTime: Date.now(),\n        endpoint: pushSubscription.endpoint,\n        auth: pushSubscription.getKey('auth')!,\n        p256dh: pushSubscription.getKey('p256dh')!\n      };\n\n      await this.tokenDetailsModel.saveTokenDetails(allDetails);\n      await this.vapidDetailsModel.saveVapidDetails(\n        swReg.scope,\n        publicVapidKey\n      );\n      return updatedToken;\n    } catch (e) {\n      await this.deleteToken(tokenDetails.fcmToken);\n      throw e;\n    }\n  }\n\n  private async getNewToken(\n    swReg: ServiceWorkerRegistration,\n    pushSubscription: PushSubscription,\n    publicVapidKey: Uint8Array\n  ): Promise<string> {\n    const tokenDetails = await this.iidModel.getToken(\n      this.messagingSenderId,\n      pushSubscription,\n      publicVapidKey\n    );\n    const allDetails: TokenDetails = {\n      swScope: swReg.scope,\n      vapidKey: publicVapidKey,\n      fcmSenderId: this.messagingSenderId,\n      fcmToken: tokenDetails.token,\n      fcmPushSet: tokenDetails.pushSet,\n      createTime: Date.now(),\n      endpoint: pushSubscription.endpoint,\n      auth: pushSubscription.getKey('auth')!,\n      p256dh: pushSubscription.getKey('p256dh')!\n    };\n    await this.tokenDetailsModel.saveTokenDetails(allDetails);\n    await this.vapidDetailsModel.saveVapidDetails(swReg.scope, publicVapidKey);\n    return tokenDetails.token;\n  }\n\n  /**\n   * This method deletes tokens that the token manager looks after,\n   * unsubscribes the token from FCM  and then unregisters the push\n   * subscription if it exists. It returns a promise that indicates\n   * whether or not the unsubscribe request was processed successfully.\n   */\n  async deleteToken(token: string): Promise<boolean> {\n    // Delete the token details from the database.\n    await this.deleteTokenFromDB(token);\n    // Unsubscribe from the SW.\n    const registration = await this.getSWRegistration_();\n    if (registration) {\n      const pushSubscription = await registration.pushManager.getSubscription();\n      if (pushSubscription) {\n        return pushSubscription.unsubscribe();\n      }\n    }\n    // If there's no SW, consider it a success.\n    return true;\n  }\n\n  /**\n   * This method will delete the token from the client database, and make a\n   * call to FCM to remove it from the server DB. Does not temper with the\n   * push subscription.\n   */\n  private async deleteTokenFromDB(token: string): Promise<void> {\n    const details = await this.tokenDetailsModel.deleteToken(token);\n    await this.iidModel.deleteToken(\n      details.fcmSenderId,\n      details.fcmToken,\n      details.fcmPushSet\n    );\n  }\n\n  // Visible for testing\n  // TODO: Make protected\n  abstract getSWRegistration_(): Promise<ServiceWorkerRegistration>;\n\n  // Visible for testing\n  // TODO: Make protected\n  abstract getPublicVapidKey_(): Promise<Uint8Array>;\n\n  /**\n   * Gets a PushSubscription for the current user.\n   */\n  getPushSubscription(\n    swRegistration: ServiceWorkerRegistration,\n    publicVapidKey: Uint8Array\n  ): Promise<PushSubscription> {\n    return swRegistration.pushManager.getSubscription().then(subscription => {\n      if (subscription) {\n        return subscription;\n      }\n\n      return swRegistration.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey: publicVapidKey\n      });\n    });\n  }\n\n  //\n  // The following methods should only be available in the window.\n  //\n\n  /**\n   * @deprecated Use Notification.requestPermission() instead.\n   * https://developer.mozilla.org/en-US/docs/Web/API/Notification/requestPermission\n   */\n  requestPermission(): Promise<void> {\n    throw errorFactory.create(ErrorCode.AVAILABLE_IN_WINDOW);\n  }\n\n  useServiceWorker(_registration: ServiceWorkerRegistration): void {\n    throw errorFactory.create(ErrorCode.AVAILABLE_IN_WINDOW);\n  }\n\n  usePublicVapidKey(_b64PublicKey: string): void {\n    throw errorFactory.create(ErrorCode.AVAILABLE_IN_WINDOW);\n  }\n\n  onMessage(\n    _nextOrObserver: NextFn<object> | Observer<object>,\n    _error?: ErrorFn,\n    _completed?: CompleteFn\n  ): Unsubscribe {\n    throw errorFactory.create(ErrorCode.AVAILABLE_IN_WINDOW);\n  }\n\n  onTokenRefresh(\n    _nextOrObserver: NextFn<object> | Observer<object>,\n    _error?: ErrorFn,\n    _completed?: CompleteFn\n  ): Unsubscribe {\n    throw errorFactory.create(ErrorCode.AVAILABLE_IN_WINDOW);\n  }\n\n  //\n  // The following methods are used by the service worker only.\n  //\n\n  setBackgroundMessageHandler(_callback: BgMessageHandler): void {\n    throw errorFactory.create(ErrorCode.AVAILABLE_IN_SW);\n  }\n\n  //\n  // The following methods are used by the service themselves and not exposed\n  // publicly or not expected to be used by developers.\n  //\n\n  /**\n   * This method is required to adhere to the Firebase interface.\n   * It closes any currently open indexdb database connections.\n   */\n  async delete(): Promise<void> {\n    await Promise.all([\n      this.tokenDetailsModel.closeDatabase(),\n      this.vapidDetailsModel.closeDatabase()\n    ]);\n  }\n\n  /**\n   * Returns the current Notification Permission state.\n   */\n  getNotificationPermission_(): NotificationPermission {\n    return Notification.permission;\n  }\n\n  getTokenDetailsModel(): TokenDetailsModel {\n    return this.tokenDetailsModel;\n  }\n\n  getVapidDetailsModel(): VapidDetailsModel {\n    return this.vapidDetailsModel;\n  }\n\n  // Visible for testing\n  // TODO: make protected\n  getIidModel(): IidModel {\n    return this.iidModel;\n  }\n}\n\n/**\n * Checks if the tokenDetails match the details provided in the clients.\n */\nfunction isTokenStillValid(\n  pushSubscription: PushSubscription,\n  publicVapidKey: Uint8Array,\n  tokenDetails: TokenDetails\n): boolean {\n  if (\n    !tokenDetails.vapidKey ||\n    !isArrayBufferEqual(publicVapidKey.buffer, tokenDetails.vapidKey.buffer)\n  ) {\n    return false;\n  }\n\n  const isEndpointEqual = pushSubscription.endpoint === tokenDetails.endpoint;\n  const isAuthEqual = isArrayBufferEqual(\n    pushSubscription.getKey('auth'),\n    tokenDetails.auth\n  );\n  const isP256dhEqual = isArrayBufferEqual(\n    pushSubscription.getKey('p256dh'),\n    tokenDetails.p256dh\n  );\n\n  return isEndpointEqual && isAuthEqual && isP256dhEqual;\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport './sw-types';\n\nimport { FirebaseApp } from '@firebase/app-types';\n\nimport {\n  MessagePayload,\n  NotificationDetails\n} from '../interfaces/message-payload';\nimport { ErrorCode, errorFactory } from '../models/errors';\nimport { DEFAULT_PUBLIC_VAPID_KEY } from '../models/fcm-details';\nimport {\n  InternalMessage,\n  MessageParameter,\n  MessageType\n} from '../models/worker-page-message';\nimport { BaseController, BgMessageHandler } from './base-controller';\n\n// Let TS know that this is a service worker\ndeclare const self: ServiceWorkerGlobalScope;\n\nconst FCM_MSG = 'FCM_MSG';\n\nexport class SwController extends BaseController {\n  private bgMessageHandler: BgMessageHandler | null = null;\n\n  constructor(app: FirebaseApp) {\n    super(app);\n\n    self.addEventListener('push', e => {\n      this.onPush(e);\n    });\n    self.addEventListener('pushsubscriptionchange', e => {\n      this.onSubChange(e);\n    });\n    self.addEventListener('notificationclick', e => {\n      this.onNotificationClick(e);\n    });\n  }\n\n  // Visible for testing\n  // TODO: Make private\n  onPush(event: PushEvent): void {\n    event.waitUntil(this.onPush_(event));\n  }\n\n  // Visible for testing\n  // TODO: Make private\n  onSubChange(event: PushSubscriptionChangeEvent): void {\n    event.waitUntil(this.onSubChange_(event));\n  }\n\n  // Visible for testing\n  // TODO: Make private\n  onNotificationClick(event: NotificationEvent): void {\n    event.waitUntil(this.onNotificationClick_(event));\n  }\n\n  /**\n   * A handler for push events that shows notifications based on the content of\n   * the payload.\n   *\n   * The payload must be a JSON-encoded Object with a `notification` key. The\n   * value of the `notification` property will be used as the NotificationOptions\n   * object passed to showNotification. Additionally, the `title` property of the\n   * notification object will be used as the title.\n   *\n   * If there is no notification data in the payload then no notification will be\n   * shown.\n   */\n  private async onPush_(event: PushEvent): Promise<void> {\n    if (!event.data) {\n      return;\n    }\n\n    let msgPayload: MessagePayload;\n    try {\n      msgPayload = event.data.json();\n    } catch (err) {\n      // Not JSON so not an FCM message\n      return;\n    }\n\n    const hasVisibleClients = await this.hasVisibleClients_();\n    if (hasVisibleClients) {\n      // App in foreground. Send to page.\n      return this.sendMessageToWindowClients_(msgPayload);\n    }\n\n    const notificationDetails = this.getNotificationData_(msgPayload);\n    if (notificationDetails) {\n      const notificationTitle = notificationDetails.title || '';\n      const reg = await this.getSWRegistration_();\n\n      const { actions } = notificationDetails;\n      const { maxActions } = Notification;\n      // tslint:enable no-any\n      if (actions && maxActions && actions.length > maxActions) {\n        console.warn(\n          `This browser only supports ${maxActions} actions.` +\n            `The remaining actions will not be displayed.`\n        );\n      }\n\n      return reg.showNotification(notificationTitle, notificationDetails);\n    } else if (this.bgMessageHandler) {\n      await this.bgMessageHandler(msgPayload);\n      return;\n    }\n  }\n\n  private async onSubChange_(\n    _event: PushSubscriptionChangeEvent\n  ): Promise<void> {\n    let registration: ServiceWorkerRegistration;\n    try {\n      registration = await this.getSWRegistration_();\n    } catch (err) {\n      throw errorFactory.create(ErrorCode.UNABLE_TO_RESUBSCRIBE, {\n        errorInfo: err\n      });\n    }\n\n    try {\n      await registration.pushManager.getSubscription();\n      // TODO: Check if it's still valid. If not, then update token.\n    } catch (err) {\n      // The best thing we can do is log this to the terminal so\n      // developers might notice the error.\n      const tokenDetailsModel = this.getTokenDetailsModel();\n      const tokenDetails = await tokenDetailsModel.getTokenDetailsFromSWScope(\n        registration.scope\n      );\n      if (!tokenDetails) {\n        // This should rarely occure, but could if indexedDB\n        // is corrupted or wiped\n        throw err;\n      }\n\n      // Attempt to delete the token if we know it's bad\n      await this.deleteToken(tokenDetails.fcmToken);\n      throw err;\n    }\n  }\n\n  private async onNotificationClick_(event: NotificationEvent): Promise<void> {\n    if (\n      !event.notification ||\n      !event.notification.data ||\n      !event.notification.data[FCM_MSG]\n    ) {\n      // Not an FCM notification, do nothing.\n      return;\n    } else if (event.action) {\n      // User clicked on an action button.\n      // This will allow devs to act on action button clicks by using a custom\n      // onNotificationClick listener that they define.\n      return;\n    }\n\n    // Prevent other listeners from receiving the event\n    event.stopImmediatePropagation();\n    event.notification.close();\n\n    const msgPayload: MessagePayload = event.notification.data[FCM_MSG];\n    if (!msgPayload.notification) {\n      // Nothing to do.\n      return;\n    }\n\n    const link =\n      (msgPayload.fcmOptions && msgPayload.fcmOptions.link) ||\n      msgPayload.notification.click_action;\n    if (!link) {\n      // Nothing to do.\n      return;\n    }\n\n    let windowClient = await this.getWindowClient_(link);\n    if (!windowClient) {\n      // Unable to find window client so need to open one.\n      windowClient = await self.clients.openWindow(link);\n    } else {\n      windowClient = await windowClient.focus();\n    }\n\n    if (!windowClient) {\n      // Window Client will not be returned if it's for a third party origin.\n      return;\n    }\n\n    // Delete notification and fcmOptions data from payload before sending to\n    // the page.\n    delete msgPayload.notification;\n    delete msgPayload.fcmOptions;\n\n    const internalMsg = createNewMsg(\n      MessageType.NOTIFICATION_CLICKED,\n      msgPayload\n    );\n\n    // Attempt to send a message to the client to handle the data\n    // Is affected by: https://github.com/slightlyoff/ServiceWorker/issues/728\n    return this.attemptToMessageClient_(windowClient, internalMsg);\n  }\n\n  // Visible for testing\n  // TODO: Make private\n  getNotificationData_(\n    msgPayload: MessagePayload\n  ): NotificationDetails | undefined {\n    if (!msgPayload) {\n      return;\n    }\n\n    if (typeof msgPayload.notification !== 'object') {\n      return;\n    }\n\n    const notificationInformation: NotificationDetails = {\n      ...msgPayload.notification\n    };\n\n    // Put the message payload under FCM_MSG name so we can identify the\n    // notification as being an FCM notification vs a notification from\n    // somewhere else (i.e. normal web push or developer generated\n    // notification).\n    notificationInformation.data = {\n      ...msgPayload.notification.data,\n      [FCM_MSG]: msgPayload\n    };\n\n    return notificationInformation;\n  }\n\n  /**\n   * Calling setBackgroundMessageHandler will opt in to some specific\n   * behaviours.\n   * 1.) If a notification doesn't need to be shown due to a window already\n   * being visible, then push messages will be sent to the page.\n   * 2.) If a notification needs to be shown, and the message contains no\n   * notification data this method will be called\n   * and the promise it returns will be passed to event.waitUntil.\n   * If you do not set this callback then all push messages will let and the\n   * developer can handle them in a their own 'push' event callback\n   *\n   * @param callback The callback to be called when a push message is received\n   * and a notification must be shown. The callback will be given the data from\n   * the push message.\n   */\n  setBackgroundMessageHandler(callback: BgMessageHandler): void {\n    if (!callback || typeof callback !== 'function') {\n      throw errorFactory.create(ErrorCode.BG_HANDLER_FUNCTION_EXPECTED);\n    }\n\n    this.bgMessageHandler = callback;\n  }\n\n  /**\n   * @param url The URL to look for when focusing a client.\n   * @return Returns an existing window client or a newly opened WindowClient.\n   */\n  // Visible for testing\n  // TODO: Make private\n  async getWindowClient_(url: string): Promise<WindowClient | null> {\n    // Use URL to normalize the URL when comparing to windowClients.\n    // This at least handles whether to include trailing slashes or not\n    const parsedURL = new URL(url, self.location.href).href;\n\n    const clientList = await getClientList();\n\n    let suitableClient: WindowClient | null = null;\n    for (let i = 0; i < clientList.length; i++) {\n      const parsedClientUrl = new URL(clientList[i].url, self.location.href)\n        .href;\n      if (parsedClientUrl === parsedURL) {\n        suitableClient = clientList[i];\n        break;\n      }\n    }\n\n    return suitableClient;\n  }\n\n  /**\n   * This message will attempt to send the message to a window client.\n   * @param client The WindowClient to send the message to.\n   * @param message The message to send to the client.\n   * @returns Returns a promise that resolves after sending the message. This\n   * does not guarantee that the message was successfully received.\n   */\n  // Visible for testing\n  // TODO: Make private\n  async attemptToMessageClient_(\n    client: WindowClient,\n    message: InternalMessage\n  ): Promise<void> {\n    // NOTE: This returns a promise in case this API is abstracted later on to\n    // do additional work\n    if (!client) {\n      throw errorFactory.create(ErrorCode.NO_WINDOW_CLIENT_TO_MSG);\n    }\n\n    client.postMessage(message);\n  }\n\n  /**\n   * @returns If there is currently a visible WindowClient, this method will\n   * resolve to true, otherwise false.\n   */\n  // Visible for testing\n  // TODO: Make private\n  async hasVisibleClients_(): Promise<boolean> {\n    const clientList = await getClientList();\n\n    return clientList.some(\n      (client: WindowClient) =>\n        client.visibilityState === 'visible' &&\n        // Ignore chrome-extension clients as that matches the background pages\n        // of extensions, which are always considered visible.\n        !client.url.startsWith('chrome-extension://')\n    );\n  }\n\n  /**\n   * @param msgPayload The data from the push event that should be sent to all\n   * available pages.\n   * @returns Returns a promise that resolves once the message has been sent to\n   * all WindowClients.\n   */\n  // Visible for testing\n  // TODO: Make private\n  async sendMessageToWindowClients_(msgPayload: MessagePayload): Promise<void> {\n    const clientList = await getClientList();\n\n    const internalMsg = createNewMsg(MessageType.PUSH_MSG_RECEIVED, msgPayload);\n\n    await Promise.all(\n      clientList.map(client =>\n        this.attemptToMessageClient_(client, internalMsg)\n      )\n    );\n  }\n\n  /**\n   * This will register the default service worker and return the registration.\n   * @return he service worker registration to be used for the push service.\n   */\n  async getSWRegistration_(): Promise<ServiceWorkerRegistration> {\n    return self.registration;\n  }\n\n  /**\n   * This will return the default VAPID key or the uint8array version of the\n   * public VAPID key provided by the developer.\n   */\n  async getPublicVapidKey_(): Promise<Uint8Array> {\n    const swReg = await this.getSWRegistration_();\n    if (!swReg) {\n      throw errorFactory.create(ErrorCode.SW_REGISTRATION_EXPECTED);\n    }\n\n    const vapidKeyFromDatabase = await this.getVapidDetailsModel().getVapidFromSWScope(\n      swReg.scope\n    );\n    if (vapidKeyFromDatabase == null) {\n      return DEFAULT_PUBLIC_VAPID_KEY;\n    }\n\n    return vapidKeyFromDatabase;\n  }\n}\n\nfunction getClientList(): Promise<WindowClient[]> {\n  return self.clients.matchAll({\n    type: 'window',\n    includeUncontrolled: true\n    // TS doesn't know that \"type: 'window'\" means it'll return WindowClient[]\n  }) as Promise<WindowClient[]>;\n}\n\nfunction createNewMsg(\n  msgType: MessageType,\n  msgData: MessagePayload\n): InternalMessage {\n  return {\n    [MessageParameter.TYPE_OF_MSG]: msgType,\n    [MessageParameter.DATA]: msgData\n  };\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport const DEFAULT_SW_PATH = '/firebase-messaging-sw.js';\nexport const DEFAULT_SW_SCOPE = '/firebase-cloud-messaging-push-scope';\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FirebaseApp } from '@firebase/app-types';\nimport {\n  CompleteFn,\n  createSubscribe,\n  ErrorFn,\n  NextFn,\n  Observer,\n  Subscribe,\n  Unsubscribe\n} from '@firebase/util';\n\nimport { base64ToArrayBuffer } from '../helpers/base64-to-array-buffer';\nimport { DEFAULT_SW_PATH, DEFAULT_SW_SCOPE } from '../models/default-sw';\nimport { ErrorCode, errorFactory } from '../models/errors';\nimport { DEFAULT_PUBLIC_VAPID_KEY } from '../models/fcm-details';\nimport {\n  InternalMessage,\n  MessageParameter,\n  MessageType\n} from '../models/worker-page-message';\nimport { BaseController } from './base-controller';\n\ninterface ManifestContent {\n  // eslint-disable-next-line camelcase\n  gcm_sender_id: string;\n}\n\nexport class WindowController extends BaseController {\n  private registrationToUse: ServiceWorkerRegistration | null = null;\n  private publicVapidKeyToUse: Uint8Array | null = null;\n  private manifestCheckPromise: Promise<void> | null = null;\n\n  private messageObserver: Observer<object> | null = null;\n  // @ts-ignore: Unused variable error, this is not implemented yet.\n  private tokenRefreshObserver: Observer<object> | null = null;\n\n  private readonly onMessageInternal: Subscribe<object> = createSubscribe(\n    observer => {\n      this.messageObserver = observer;\n    }\n  );\n\n  private readonly onTokenRefreshInternal: Subscribe<object> = createSubscribe(\n    observer => {\n      this.tokenRefreshObserver = observer;\n    }\n  );\n\n  /**\n   * A service that provides a MessagingService instance.\n   */\n  constructor(app: FirebaseApp) {\n    super(app);\n\n    this.setupSWMessageListener_();\n  }\n\n  /**\n   * This method returns an FCM token if it can be generated.\n   * The return promise will reject if the browser doesn't support\n   * FCM, if permission is denied for notifications or it's not\n   * possible to generate a token.\n   *\n   * @return Returns a promise that resolves to an FCM token or null if\n   * permission isn't granted.\n   */\n  async getToken(): Promise<string | null> {\n    if (!this.manifestCheckPromise) {\n      this.manifestCheckPromise = manifestCheck();\n    }\n    await this.manifestCheckPromise;\n    return super.getToken();\n  }\n\n  /**\n   * Request permission if it is not currently granted\n   *\n   * @return Resolves if the permission was granted, otherwise rejects\n   *\n   * @deprecated Use Notification.requestPermission() instead.\n   * https://developer.mozilla.org/en-US/docs/Web/API/Notification/requestPermission\n   */\n  async requestPermission(): Promise<void> {\n    if (this.getNotificationPermission_() === 'granted') {\n      return;\n    }\n\n    const permissionResult = await Notification.requestPermission();\n    if (permissionResult === 'granted') {\n      return;\n    } else if (permissionResult === 'denied') {\n      throw errorFactory.create(ErrorCode.PERMISSION_BLOCKED);\n    } else {\n      throw errorFactory.create(ErrorCode.PERMISSION_DEFAULT);\n    }\n  }\n\n  /**\n   * This method allows a developer to override the default service worker and\n   * instead use a custom service worker.\n   *\n   * @param registration The service worker registration that should be used to\n   * receive the push messages.\n   */\n  useServiceWorker(registration: ServiceWorkerRegistration): void {\n    if (!(registration instanceof ServiceWorkerRegistration)) {\n      throw errorFactory.create(ErrorCode.SW_REGISTRATION_EXPECTED);\n    }\n\n    if (this.registrationToUse != null) {\n      throw errorFactory.create(ErrorCode.USE_SW_BEFORE_GET_TOKEN);\n    }\n\n    this.registrationToUse = registration;\n  }\n\n  /**\n   * This method allows a developer to override the default vapid key\n   * and instead use a custom VAPID public key.\n   *\n   * @param publicKey A URL safe base64 encoded string.\n   */\n  usePublicVapidKey(publicKey: string): void {\n    if (typeof publicKey !== 'string') {\n      throw errorFactory.create(ErrorCode.INVALID_PUBLIC_VAPID_KEY);\n    }\n\n    if (this.publicVapidKeyToUse != null) {\n      throw errorFactory.create(ErrorCode.USE_PUBLIC_KEY_BEFORE_GET_TOKEN);\n    }\n\n    const parsedKey = base64ToArrayBuffer(publicKey);\n\n    if (parsedKey.length !== 65) {\n      throw errorFactory.create(ErrorCode.PUBLIC_KEY_DECRYPTION_FAILED);\n    }\n\n    this.publicVapidKeyToUse = parsedKey;\n  }\n\n  /**\n   * @export\n   * @param nextOrObserver An observer object or a function triggered on\n   * message.\n   * @param error A function triggered on message error.\n   * @param completed function triggered when the observer is removed.\n   * @return The unsubscribe function for the observer.\n   */\n  onMessage(\n    nextOrObserver: NextFn<object> | Observer<object>,\n    error?: ErrorFn,\n    completed?: CompleteFn\n  ): Unsubscribe {\n    if (typeof nextOrObserver === 'function') {\n      return this.onMessageInternal(nextOrObserver, error, completed);\n    } else {\n      return this.onMessageInternal(nextOrObserver);\n    }\n  }\n\n  /**\n   * @param nextOrObserver An observer object or a function triggered on token\n   * refresh.\n   * @param error A function triggered on token refresh error.\n   * @param completed function triggered when the observer is removed.\n   * @return The unsubscribe function for the observer.\n   */\n  onTokenRefresh(\n    nextOrObserver: NextFn<object> | Observer<object>,\n    error?: ErrorFn,\n    completed?: CompleteFn\n  ): Unsubscribe {\n    if (typeof nextOrObserver === 'function') {\n      return this.onTokenRefreshInternal(nextOrObserver, error, completed);\n    } else {\n      return this.onTokenRefreshInternal(nextOrObserver);\n    }\n  }\n\n  /**\n   * Given a registration, wait for the service worker it relates to\n   * become activer\n   * @param registration Registration to wait for service worker to become active\n   * @return Wait for service worker registration to become active\n   */\n  // Visible for testing\n  // TODO: Make private\n  waitForRegistrationToActivate_(\n    registration: ServiceWorkerRegistration\n  ): Promise<ServiceWorkerRegistration> {\n    const serviceWorker =\n      registration.installing || registration.waiting || registration.active;\n\n    return new Promise<ServiceWorkerRegistration>((resolve, reject) => {\n      if (!serviceWorker) {\n        // This is a rare scenario but has occured in firefox\n        reject(errorFactory.create(ErrorCode.NO_SW_IN_REG));\n        return;\n      }\n      // Because the Promise function is called on next tick there is a\n      // small chance that the worker became active or redundant already.\n      if (serviceWorker.state === 'activated') {\n        resolve(registration);\n        return;\n      }\n\n      if (serviceWorker.state === 'redundant') {\n        reject(errorFactory.create(ErrorCode.SW_REG_REDUNDANT));\n        return;\n      }\n\n      const stateChangeListener = (): void => {\n        if (serviceWorker.state === 'activated') {\n          resolve(registration);\n        } else if (serviceWorker.state === 'redundant') {\n          reject(errorFactory.create(ErrorCode.SW_REG_REDUNDANT));\n        } else {\n          // Return early and wait to next state change\n          return;\n        }\n        serviceWorker.removeEventListener('statechange', stateChangeListener);\n      };\n      serviceWorker.addEventListener('statechange', stateChangeListener);\n    });\n  }\n\n  /**\n   * This will register the default service worker and return the registration\n   * @return The service worker registration to be used for the push service.\n   */\n  getSWRegistration_(): Promise<ServiceWorkerRegistration> {\n    if (this.registrationToUse) {\n      return this.waitForRegistrationToActivate_(this.registrationToUse);\n    }\n\n    // Make the registration null so we know useServiceWorker will not\n    // use a new service worker as registrationToUse is no longer undefined\n    this.registrationToUse = null;\n\n    return navigator.serviceWorker\n      .register(DEFAULT_SW_PATH, {\n        scope: DEFAULT_SW_SCOPE\n      })\n      .catch((err: Error) => {\n        throw errorFactory.create(ErrorCode.FAILED_DEFAULT_REGISTRATION, {\n          browserErrorMessage: err.message\n        });\n      })\n      .then((registration: ServiceWorkerRegistration) => {\n        return this.waitForRegistrationToActivate_(registration).then(() => {\n          this.registrationToUse = registration;\n\n          // We update after activation due to an issue with Firefox v49 where\n          // a race condition occassionally causes the service worker to not\n          // install\n          // tslint:disable-next-line:no-floating-promises\n          registration.update();\n\n          return registration;\n        });\n      });\n  }\n\n  /**\n   * This will return the default VAPID key or the uint8array version of the public VAPID key\n   * provided by the developer.\n   */\n  async getPublicVapidKey_(): Promise<Uint8Array> {\n    if (this.publicVapidKeyToUse) {\n      return this.publicVapidKeyToUse;\n    }\n\n    return DEFAULT_PUBLIC_VAPID_KEY;\n  }\n\n  /**\n   * This method will set up a message listener to handle\n   * events from the service worker that should trigger\n   * events in the page.\n   */\n  // Visible for testing\n  // TODO: Make private\n  setupSWMessageListener_(): void {\n    navigator.serviceWorker.addEventListener(\n      'message',\n      event => {\n        if (!event.data || !event.data[MessageParameter.TYPE_OF_MSG]) {\n          // Not a message from FCM\n          return;\n        }\n\n        const workerPageMessage: InternalMessage = event.data;\n        switch (workerPageMessage[MessageParameter.TYPE_OF_MSG]) {\n          case MessageType.PUSH_MSG_RECEIVED:\n          case MessageType.NOTIFICATION_CLICKED:\n            const pushMessage = workerPageMessage[MessageParameter.DATA];\n            if (this.messageObserver) {\n              this.messageObserver.next(pushMessage);\n            }\n            break;\n          default:\n            // Noop.\n            break;\n        }\n      },\n      false\n    );\n  }\n}\n\n/**\n * The method checks that a manifest is defined and has the correct GCM\n * sender ID.\n * @return Returns a promise that resolves if the manifest matches\n * our required sender ID\n */\n// Exported for testing\nexport async function manifestCheck(): Promise<void> {\n  const manifestTag = document.querySelector<HTMLAnchorElement>(\n    'link[rel=\"manifest\"]'\n  );\n\n  if (!manifestTag) {\n    return;\n  }\n\n  let manifestContent: ManifestContent;\n  try {\n    const response = await fetch(manifestTag.href);\n    manifestContent = await response.json();\n  } catch (e) {\n    // If the download or parsing fails allow check.\n    // We only want to error if we KNOW that the gcm_sender_id is incorrect.\n    return;\n  }\n\n  if (!manifestContent || !manifestContent.gcm_sender_id) {\n    return;\n  }\n\n  if (manifestContent.gcm_sender_id !== '103953800507') {\n    throw errorFactory.create(ErrorCode.INCORRECT_GCM_SENDER_ID);\n  }\n}\n","/**\n * @license\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport firebase from '@firebase/app';\nimport {\n  _FirebaseNamespace,\n  FirebaseServiceFactory\n} from '@firebase/app-types/private';\nimport { FirebaseMessaging } from '@firebase/messaging-types';\n\nimport { SwController } from './src/controllers/sw-controller';\nimport { WindowController } from './src/controllers/window-controller';\nimport { ErrorCode, errorFactory } from './src/models/errors';\n\nexport function registerMessaging(instance: _FirebaseNamespace): void {\n  const messagingName = 'messaging';\n\n  const factoryMethod: FirebaseServiceFactory = app => {\n    if (!isSupported()) {\n      throw errorFactory.create(ErrorCode.UNSUPPORTED_BROWSER);\n    }\n\n    if (self && 'ServiceWorkerGlobalScope' in self) {\n      // Running in ServiceWorker context\n      return new SwController(app);\n    } else {\n      // Assume we are in the window context.\n      return new WindowController(app);\n    }\n  };\n\n  const namespaceExports = {\n    isSupported\n  };\n\n  instance.INTERNAL.registerService(\n    messagingName,\n    factoryMethod,\n    namespaceExports\n  );\n}\n\nregisterMessaging(firebase as _FirebaseNamespace);\n\n/**\n * Define extension behavior of `registerMessaging`\n */\ndeclare module '@firebase/app-types' {\n  interface FirebaseNamespace {\n    messaging: {\n      (app?: FirebaseApp): FirebaseMessaging;\n      isSupported(): boolean;\n    };\n  }\n  interface FirebaseApp {\n    messaging(): FirebaseMessaging;\n  }\n}\n\nexport function isSupported(): boolean {\n  if (self && 'ServiceWorkerGlobalScope' in self) {\n    // Running in ServiceWorker context\n    return isSWControllerSupported();\n  } else {\n    // Assume we are in the window context.\n    return isWindowControllerSupported();\n  }\n}\n\n/**\n * Checks to see if the required APIs exist.\n */\nfunction isWindowControllerSupported(): boolean {\n  return (\n    navigator.cookieEnabled &&\n    'serviceWorker' in navigator &&\n    'PushManager' in window &&\n    'Notification' in window &&\n    'fetch' in window &&\n    ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') &&\n    PushSubscription.prototype.hasOwnProperty('getKey')\n  );\n}\n\n/**\n * Checks to see if the required APIs exist within SW Context.\n */\nfunction isSWControllerSupported(): boolean {\n  return (\n    'PushManager' in self &&\n    'Notification' in self &&\n    ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') &&\n    PushSubscription.prototype.hasOwnProperty('getKey')\n  );\n}\n"],"names":["ErrorFactory","tslib_1.__extends","createSubscribe"],"mappings":";;;;;;;;;;AAAA;;;;;;;;;;;;;;;GAeG;;ACfH;;;;;;;;;;;;;;;;;AAiBA,AA4CO,IAAM,SAAS;IACpB,2DACE,+CAA+C;IACjD,mDACE,uDAAuD;IACzD,sDACE,sDAAsD;IACxD,0CACE,gDAAgD;QAChD,gEAAgE;IAClE,oDACE,kEAAkE;IACpE,oDACE,gEAAgE;IAClE,sDACE,yCAAyC;QACzC,mCAAmC;IACrC,0DAAmC,kCAAkC;IACrE,4EACE,gCAAgC;QAChC,gDAAgD;IAClD,gEACE,uDAAuD;IACzD,8DACE,wCAAwC;QACxC,kCAAkC;IACpC,sDACE,8CAA8C;IAChD,gDACE,4DAA4D;IAC9D,4DACE,mEAAmE;IACrE,gEACE,0DAA0D;IAC5D,sEACE,6DAA6D;IAC/D,gEACE,4CAA4C;QAC5C,6BAA6B;IAC/B,sDACE,kEAAkE;IACpE,0DACE,uDAAuD;IACzD,8DACE,oEAAoE;QACpE,yEAAyE;IAC3E,wDACE,mCAAmC;QACnC,gDAAgD;IAClD,4DACE,2CAA2C;QAC3C,0CAA0C;IAC5C,4DACE,0CAA0C;QAC1C,0DAA0D;IAC5D,wEACE,gEAAgE;IAClE,8DACE,8DAA8D;IAChE,0DACE,0CAA0C;QAC1C,iEAAiE;QACjE,kCAAkC;IACpC,wEACE,8BAA8B;QAC9B,uEAAuE;QACvE,qBAAqB;IACvB,4DACE,6CAA6C;IAC/C,wCACE,kDAAkD;QAClD,sEAAsE;IACxE,8DACE,wCAAwC;QACxC,oEAAoE;IACtE,kCACE,oDAAoD;QACpD,sBAAsB;IACxB,0CACE,yDAAyD;IAC3D,gDACE,oDAAoD;IACtD,kCACE,kDAAkD;QAClD,uBAAuB;IACzB,wCACE,qDAAqD;QACrD,8BAA8B;IAChC,8DAAqC,qCAAqC;IAC1E,gEACE,wCAAwC;IAC1C,8EACE,qEAAqE;QACrE,oEAAoE;IACtE,8EACE,6DAA6D;OAChE,CAAC;AAUF,AAAO,IAAM,YAAY,GAAG,IAAIA,iBAAY,CAC1C,WAAW,EACX,WAAW,EACX,SAAS,CACV,CAAC;;AC3KF;;;;;;;;;;;;;;;;AAiBA,AAAO,IAAM,wBAAwB,GAAG,IAAI,UAAU,CAAC;IACrD,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;IACJ,IAAI;CACL,CAAC,CAAC;AAEH,AAKO,IAAM,QAAQ,GAAG,4BAA4B,CAAC;;AC1FrD;;;;;;;;;;;;;;;;AAmBA,AAAA,IAAY,gBAGX;AAHD,WAAY,gBAAgB;IAC1B,+DAA2C,CAAA;IAC3C,wDAAoC,CAAA;CACrC,EAHW,gBAAgB,KAAhB,gBAAgB,QAG3B;AAED,AAAA,IAAY,WAGX;AAHD,WAAY,WAAW;IACrB,sDAAuC,CAAA;IACvC,4DAA6C,CAAA;CAC9C,EAHW,WAAW,KAAX,WAAW,QAGtB;;AC3BD;;;;;;;;;;;;;;;;AAiBA,SAAgB,kBAAkB,CAChC,CAAqC,EACrC,CAAqC;IAErC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI,IAAI,EAAE;QAC1B,OAAO,KAAK,CAAC;KACd;IAED,IAAI,CAAC,KAAK,CAAC,EAAE;QACX,OAAO,IAAI,CAAC;KACb;IAED,IAAI,CAAC,CAAC,UAAU,KAAK,CAAC,CAAC,UAAU,EAAE;QACjC,OAAO,KAAK,CAAC;KACd;IAED,IAAM,KAAK,GAAG,IAAI,QAAQ,CAAC,CAAC,CAAC,CAAC;IAC9B,IAAM,KAAK,GAAG,IAAI,QAAQ,CAAC,CAAC,CAAC,CAAC;IAE9B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,CAAC,EAAE,EAAE;QACrC,IAAI,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC,KAAK,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE;YAC3C,OAAO,KAAK,CAAC;SACd;KACF;IAED,OAAO,IAAI,CAAC;CACb;;AC3CD;;;;;;;;;;;;;;;;AAiBA,SAAS,QAAQ,CAAC,WAAqC;IACrD,IAAM,YAAY,GAAG,IAAI,UAAU,CAAC,WAAW,CAAC,CAAC;IACjD,OAAO,IAAI,CAAC,MAAM,CAAC,YAAY,OAAnB,MAAM,mBAAiB,YAAY,GAAE,CAAC;CACnD;AAED,SAAgB,mBAAmB,CACjC,WAAqC;IAErC,IAAM,YAAY,GAAG,QAAQ,CAAC,WAAW,CAAC,CAAC;IAC3C,OAAO,YAAY;SAChB,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC;SACjB,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC;SACnB,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;CACxB;;AC9BD;;;;;;;;;;;;;;;;AA+BA;IAAA;KAgLC;IA/KO,2BAAQ,GAAd,UACE,QAAgB,EAChB,YAA8B,EAC9B,cAA0B;;;;;;wBAEpB,MAAM,GAAG,mBAAmB,CAAC,YAAY,CAAC,MAAM,CAAC,QAAQ,CAAE,CAAC,CAAC;wBAC7D,IAAI,GAAG,mBAAmB,CAAC,YAAY,CAAC,MAAM,CAAC,MAAM,CAAE,CAAC,CAAC;wBAE3D,gBAAgB,GAClB,uBAAqB,QAAQ,MAAG;6BAChC,cAAY,YAAY,CAAC,QAAQ,MAAG,CAAA;6BACpC,oBAAkB,MAAM,MAAG,CAAA;6BAC3B,qBAAmB,IAAM,CAAA,CAAC;wBAE5B,IACE,CAAC,kBAAkB,CACjB,cAAc,CAAC,MAAM,EACrB,wBAAwB,CAAC,MAAM,CAChC,EACD;4BACM,iBAAiB,GAAG,mBAAmB,CAAC,cAAc,CAAC,CAAC;4BAC9D,gBAAgB,IAAI,0BAAwB,iBAAmB,CAAC;yBACjE;wBAEK,OAAO,GAAG,IAAI,OAAO,EAAE,CAAC;wBAC9B,OAAO,CAAC,MAAM,CAAC,cAAc,EAAE,mCAAmC,CAAC,CAAC;wBAE9D,gBAAgB,GAAG;4BACvB,MAAM,EAAE,MAAM;4BACd,OAAO,SAAA;4BACP,IAAI,EAAE,gBAAgB;yBACvB,CAAC;;;;wBAIiB,qBAAM,KAAK,CAC1B,QAAQ,GAAG,wBAAwB,EACnC,gBAAgB,CACjB,EAAA;;wBAHK,QAAQ,GAAG,SAGhB;wBAEc,qBAAM,QAAQ,CAAC,IAAI,EAAE,EAAA;;wBAApC,YAAY,GAAG,SAAqB,CAAC;;;;wBAErC,MAAM,YAAY,CAAC,MAAM,wDAAmC;4BAC1D,SAAS,EAAE,KAAG;yBACf,CAAC,CAAC;;wBAGL,IAAI,YAAY,CAAC,KAAK,EAAE;4BAChB,OAAO,GAAG,YAAY,CAAC,KAAK,CAAC,OAAO,CAAC;4BAC3C,MAAM,YAAY,CAAC,MAAM,wDAAmC;gCAC1D,SAAS,EAAE,OAAO;6BACnB,CAAC,CAAC;yBACJ;wBAED,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE;4BACvB,MAAM,YAAY,CAAC,MAAM,2DAAoC,CAAC;yBAC/D;wBAED,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE;4BACzB,MAAM,YAAY,CAAC,MAAM,iEAAuC,CAAC;yBAClE;wBAED,sBAAO;gCACL,KAAK,EAAE,YAAY,CAAC,KAAK;gCACzB,OAAO,EAAE,YAAY,CAAC,OAAO;6BAC9B,EAAC;;;;KACH;;;;IAKK,8BAAW,GAAjB,UACE,QAAgB,EAChB,QAAgB,EAChB,UAAkB,EAClB,YAA8B,EAC9B,cAA0B;;;;;;wBAEpB,MAAM,GAAG,mBAAmB,CAAC,YAAY,CAAC,MAAM,CAAC,QAAQ,CAAE,CAAC,CAAC;wBAC7D,IAAI,GAAG,mBAAmB,CAAC,YAAY,CAAC,MAAM,CAAC,MAAM,CAAE,CAAC,CAAC;wBAE3D,aAAa,GACf,cAAY,UAAU,MAAG;6BACzB,WAAS,QAAQ,MAAG,CAAA;6BACpB,uBAAqB,QAAQ,MAAG,CAAA;6BAChC,cAAY,YAAY,CAAC,QAAQ,MAAG,CAAA;6BACpC,oBAAkB,MAAM,MAAG,CAAA;6BAC3B,qBAAmB,IAAM,CAAA,CAAC;wBAE5B,IACE,CAAC,kBAAkB,CACjB,cAAc,CAAC,MAAM,EACrB,wBAAwB,CAAC,MAAM,CAChC,EACD;4BACM,iBAAiB,GAAG,mBAAmB,CAAC,cAAc,CAAC,CAAC;4BAC9D,aAAa,IAAI,0BAAwB,iBAAmB,CAAC;yBAC9D;wBAEK,OAAO,GAAG,IAAI,OAAO,EAAE,CAAC;wBAC9B,OAAO,CAAC,MAAM,CAAC,cAAc,EAAE,mCAAmC,CAAC,CAAC;wBAE9D,aAAa,GAAG;4BACpB,MAAM,EAAE,MAAM;4BACd,OAAO,SAAA;4BACP,IAAI,EAAE,aAAa;yBACpB,CAAC;;;;wBAIiB,qBAAM,KAAK,CAC1B,QAAQ,GAAG,wBAAwB,EACnC,aAAa,CACd,EAAA;;wBAHK,QAAQ,GAAG,SAGhB;wBACc,qBAAM,QAAQ,CAAC,IAAI,EAAE,EAAA;;wBAApC,YAAY,GAAG,SAAqB,CAAC;;;;wBAErC,MAAM,YAAY,CAAC,MAAM,kDAAgC;4BACvD,SAAS,EAAE,KAAG;yBACf,CAAC,CAAC;;wBAGL,IAAI,YAAY,CAAC,KAAK,EAAE;4BAChB,OAAO,GAAG,YAAY,CAAC,KAAK,CAAC,OAAO,CAAC;4BAC3C,MAAM,YAAY,CAAC,MAAM,kDAAgC;gCACvD,SAAS,EAAE,OAAO;6BACnB,CAAC,CAAC;yBACJ;wBAED,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE;4BACvB,MAAM,YAAY,CAAC,MAAM,qDAAiC,CAAC;yBAC5D;wBAED,sBAAO,YAAY,CAAC,KAAK,EAAC;;;;KAC3B;;;;IAKK,8BAAW,GAAjB,UACE,QAAgB,EAChB,QAAgB,EAChB,UAAkB;;;;;;wBAEZ,kBAAkB,GACtB,uBAAqB,QAAQ,MAAG;6BAChC,WAAS,QAAQ,MAAG,CAAA;6BACpB,aAAW,UAAY,CAAA,CAAC;wBAEpB,OAAO,GAAG,IAAI,OAAO,EAAE,CAAC;wBAC9B,OAAO,CAAC,MAAM,CAAC,cAAc,EAAE,mCAAmC,CAAC,CAAC;wBAE9D,kBAAkB,GAAG;4BACzB,MAAM,EAAE,MAAM;4BACd,OAAO,SAAA;4BACP,IAAI,EAAE,kBAAkB;yBACzB,CAAC;;;;wBAGiB,qBAAM,KAAK,CAC1B,QAAQ,GAAG,0BAA0B,EACrC,kBAAkB,CACnB,EAAA;;wBAHK,QAAQ,GAAG,SAGhB;wBACiC,qBAAM,QAAQ,CAAC,IAAI,EAAE,EAAA;;wBAAjD,YAAY,GAAgB,SAAqB;wBACvD,IAAI,YAAY,CAAC,KAAK,EAAE;4BAChB,OAAO,GAAG,YAAY,CAAC,KAAK,CAAC,OAAO,CAAC;4BAC3C,MAAM,YAAY,CAAC,MAAM,4DAAqC;gCAC5D,SAAS,EAAE,OAAO;6BACnB,CAAC,CAAC;yBACJ;;;;wBAED,MAAM,YAAY,CAAC,MAAM,4DAAqC;4BAC5D,SAAS,EAAE,KAAG;yBACf,CAAC,CAAC;;;;;KAEN;IACH,eAAC;CAAA,IAAA;;AC/MD;;;;;;;;;;;;;;;;AAiBA,SAAgB,mBAAmB,CAAC,YAAoB;IACtD,IAAM,OAAO,GAAG,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,YAAY,CAAC,MAAM,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;IAChE,IAAM,MAAM,GAAG,CAAC,YAAY,GAAG,OAAO;SACnC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC;SACnB,OAAO,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;IAEtB,IAAM,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC;IAC7B,IAAM,WAAW,GAAG,IAAI,UAAU,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;IAEnD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE;QACvC,WAAW,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;KACxC;IACD,OAAO,WAAW,CAAC;CACpB;;AC9BD;;;;;;;;;;;;;;;;AAiBA,AAcA,IAAM,WAAW,GAAG,WAAW,CAAC;AAChC,IAAM,qBAAqB,GAAG,wBAAwB,CAAC;AAEvD,SAAS,QAAQ,CAAC,EAAe;IAC/B,IAAI,CAAC,EAAE,CAAC,gBAAgB,CAAC,QAAQ,CAAC,qBAAqB,CAAC,EAAE;;;QAGxD,OAAO;KACR;IAED,IAAM,WAAW,GAAG,EAAE,CAAC,WAAW,CAAC,qBAAqB,CAAC,CAAC;IAC1D,IAAM,WAAW,GAAG,WAAW,CAAC,WAAW,CAAC,qBAAqB,CAAC,CAAC;IAEnE,IAAM,QAAQ,GAAG,IAAI,QAAQ,EAAE,CAAC;IAEhC,IAAM,iBAAiB,GAAe,WAAW,CAAC,UAAU,EAAE,CAAC;IAC/D,iBAAiB,CAAC,OAAO,GAAG,UAAA,KAAK;;QAE/B,OAAO,CAAC,IAAI,CAAC,4BAA4B,EAAE,KAAK,CAAC,CAAC;KACnD,CAAC;IAEF,iBAAiB,CAAC,SAAS,GAAG;QAC5B,IAAM,MAAM,GAAG,iBAAiB,CAAC,MAAM,CAAC;QACxC,IAAI,MAAM,EAAE;;;YAGV,IAAM,YAAY,GAAG,MAAM,CAAC,KAAK,CAAC;;YAGlC,QAAQ,CAAC,WAAW,CAClB,YAAY,CAAC,WAAW,EACxB,YAAY,CAAC,QAAQ,EACrB,YAAY,CAAC,UAAU,CACxB,CAAC;YAEF,MAAM,CAAC,QAAQ,EAAE,CAAC;SACnB;aAAM;YACL,EAAE,CAAC,KAAK,EAAE,CAAC;YACX,SAAS,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;SACvC;KACF,CAAC;CACH;AAED,SAAgB,OAAO;IACrB,IAAM,OAAO,GAAqB,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAC9D,OAAO,CAAC,OAAO,GAAG,UAAA,MAAM;;KAEvB,CAAC;IACF,OAAO,CAAC,SAAS,GAAG,UAAA,MAAM;QACxB,IAAM,EAAE,GAAG,OAAO,CAAC,MAAM,CAAC;QAC1B,QAAQ,CAAC,EAAE,CAAC,CAAC;KACd,CAAC;CACH;;ACnFD;;;;;;;;;;;;;;;;AAiBA;IAAA;QACU,cAAS,GAAgC,IAAI,CAAC;KAsGvD;;IArFC,yBAAG,GAAH,UAAO,GAAgB;QACrB,OAAO,IAAI,CAAC,iBAAiB,CAAC,UAAA,WAAW,IAAI,OAAA,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,GAAA,CAAC,CAAC;KACpE;;IAGD,8BAAQ,GAAR,UAAY,KAAa,EAAE,GAAgB;QACzC,SAAS,UAAU,CAAC,WAA2B;YAC7C,IAAM,QAAQ,GAAG,WAAW,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;YAC1C,OAAO,QAAQ,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;SAC1B;QAED,OAAO,IAAI,CAAC,iBAAiB,CAAC,UAAU,CAAC,CAAC;KAC3C;;;IAID,yBAAG,GAAH,UAAI,KAAc;QAChB,OAAO,IAAI,CAAC,iBAAiB,CAC3B,UAAA,WAAW,IAAI,OAAA,WAAW,CAAC,GAAG,CAAC,KAAK,CAAC,GAAA,EACrC,WAAW,CACZ,CAAC;KACH;;IAGD,4BAAM,GAAN,UAAO,GAA8B;QACnC,OAAO,IAAI,CAAC,iBAAiB,CAC3B,UAAA,WAAW,IAAI,OAAA,WAAW,CAAC,MAAM,CAAC,GAAG,CAAC,GAAA,EACtC,WAAW,CACZ,CAAC;KACH;;;;IAKK,mCAAa,GAAnB;;;;;;6BACM,IAAI,CAAC,SAAS,EAAd,wBAAc;wBACL,qBAAM,IAAI,CAAC,SAAS,EAAA;;wBAAzB,EAAE,GAAG,SAAoB;wBAC/B,EAAE,CAAC,KAAK,EAAE,CAAC;wBACX,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;;;;;;KAEzB;;;;;;;IAQa,uCAAiB,GAA/B,UACE,UAAuD,EACvD,IAA2C;QAA3C,qBAAA,EAAA,iBAA2C;;;;;4BAEhC,qBAAM,IAAI,CAAC,KAAK,EAAE,EAAA;;wBAAvB,EAAE,GAAG,SAAkB;wBACvB,WAAW,GAAG,EAAE,CAAC,WAAW,CAAC,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,CAAC;wBACzD,OAAO,GAAG,WAAW,CAAC,WAAW,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;wBAC/C,qBAAM,SAAS,CAAI,UAAU,CAAC,OAAO,CAAC,CAAC,EAAA;;wBAAhD,MAAM,GAAG,SAAuC;wBAEtD,sBAAO,IAAI,OAAO,CAAI,UAAC,OAAO,EAAE,MAAM;gCACpC,WAAW,CAAC,UAAU,GAAG;oCACvB,OAAO,CAAC,MAAM,CAAC,CAAC;iCACjB,CAAC;gCACF,WAAW,CAAC,OAAO,GAAG;oCACpB,MAAM,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;iCAC3B,CAAC;6BACH,CAAC,EAAC;;;;KACJ;;IAGO,2BAAK,GAAb;QAAA,iBAgBC;QAfC,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE;YACnB,IAAI,CAAC,SAAS,GAAG,IAAI,OAAO,CAAc,UAAC,OAAO,EAAE,MAAM;gBACxD,IAAM,OAAO,GAAG,SAAS,CAAC,IAAI,CAAC,KAAI,CAAC,MAAM,EAAE,KAAI,CAAC,SAAS,CAAC,CAAC;gBAC5D,OAAO,CAAC,SAAS,GAAG;oBAClB,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;iBACzB,CAAC;gBACF,OAAO,CAAC,OAAO,GAAG;oBAChB,KAAI,CAAC,SAAS,GAAG,IAAI,CAAC;oBACtB,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;iBACvB,CAAC;gBACF,OAAO,CAAC,eAAe,GAAG,UAAA,KAAK,IAAI,OAAA,KAAI,CAAC,WAAW,CAAC,OAAO,EAAE,KAAK,CAAC,GAAA,CAAC;aACrE,CAAC,CAAC;SACJ;QAED,OAAO,IAAI,CAAC,SAAS,CAAC;KACvB;IACH,kBAAC;CAAA,IAAA;AAED;AACA,SAAS,SAAS,CAAI,OAAmB;IACvC,OAAO,IAAI,OAAO,CAAI,UAAC,OAAO,EAAE,MAAM;QACpC,OAAO,CAAC,SAAS,GAAG;YAClB,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;SACzB,CAAC;QACF,OAAO,CAAC,OAAO,GAAG;YAChB,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;SACvB,CAAC;KACH,CAAC,CAAC;CACJ;;ACpID;;;;;;;;;;;;;;;;AAuBA;IAAuCC,6CAAW;IAAlD;QAAA,qEAgKC;QA/JoB,YAAM,GAAW,sBAAsB,CAAC;QACxC,eAAS,GAAW,CAAC,CAAC;QACtB,qBAAe,GAAW,wBAAwB,CAAC;;KA6JvE;IA3JW,uCAAW,GAArB,UACE,OAAyB,EACzB,KAA4B;QAE5B,IAAM,EAAE,GAAgB,OAAO,CAAC,MAAM,CAAC;;QAGvC,QAAQ,KAAK,CAAC,UAAU;YACtB,KAAK,CAAC,EAAE;;gBAEN,IAAM,WAAW,GAAG,EAAE,CAAC,iBAAiB,CAAC,IAAI,CAAC,eAAe,EAAE;oBAC7D,OAAO,EAAE,SAAS;iBACnB,CAAC,CAAC;;gBAGH,WAAW,CAAC,WAAW,CAAC,aAAa,EAAE,aAAa,EAAE;oBACpD,MAAM,EAAE,KAAK;iBACd,CAAC,CAAC;gBAEH,WAAW,CAAC,WAAW,CAAC,UAAU,EAAE,UAAU,EAAE,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC;aACnE;YAED,KAAK,CAAC,EAAE;;;;gBAIN,OAAO,EAAE,CAAC;aACX;YAED,KAAK,CAAC,EAAE;gBACN,IAAM,WAAW,GAAG,OAAO,CAAC,WAAY,CAAC,WAAW,CAClD,IAAI,CAAC,eAAe,CACrB,CAAC;gBACF,IAAM,eAAa,GAAG,WAAW,CAAC,UAAU,EAAE,CAAC;gBAC/C,eAAa,CAAC,SAAS,GAAG;oBACxB,IAAM,MAAM,GAA8B,eAAa,CAAC,MAAM,CAAC;oBAC/D,IAAI,MAAM,EAAE;wBACV,IAAM,KAAK,GAAG,MAAM,CAAC,KAAK,CAAC;wBAC3B,IAAM,QAAQ,wBAA+B,KAAK,CAAE,CAAC;wBAErD,IAAI,CAAC,KAAK,CAAC,UAAU,EAAE;4BACrB,QAAQ,CAAC,UAAU,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;yBAClC;wBAED,IAAI,OAAO,KAAK,CAAC,QAAQ,KAAK,QAAQ,EAAE;4BACtC,QAAQ,CAAC,QAAQ,GAAG,mBAAmB,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;yBACzD;wBAED,IAAI,OAAO,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE;4BAClC,QAAQ,CAAC,IAAI,GAAG,mBAAmB,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC;yBACxD;wBAED,IAAI,OAAO,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE;4BAClC,QAAQ,CAAC,MAAM,GAAG,mBAAmB,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC;yBAC5D;wBAED,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;wBACxB,MAAM,CAAC,QAAQ,EAAE,CAAC;qBACnB;iBACF,CAAC;aACH;YAED,QAAQ;SACT;KACF;;;;IAKK,oDAAwB,GAA9B,UACE,QAAgB;;;gBAEhB,IAAI,CAAC,QAAQ,EAAE;oBACb,MAAM,YAAY,CAAC,MAAM,6BAAqB,CAAC;iBAChD;gBAED,cAAc,CAAC,EAAE,QAAQ,UAAA,EAAE,CAAC,CAAC;gBAE7B,sBAAO,IAAI,CAAC,QAAQ,CAAe,UAAU,EAAE,QAAQ,CAAC,EAAC;;;KAC1D;;;;;;IAOK,sDAA0B,GAAhC,UACE,OAAe;;;gBAEf,IAAI,CAAC,OAAO,EAAE;oBACZ,MAAM,YAAY,CAAC,MAAM,6BAAqB,CAAC;iBAChD;gBAED,cAAc,CAAC,EAAE,OAAO,SAAA,EAAE,CAAC,CAAC;gBAE5B,sBAAO,IAAI,CAAC,GAAG,CAAe,OAAO,CAAC,EAAC;;;KACxC;;;;;IAMK,4CAAgB,GAAtB,UAAuB,YAA0B;;;gBAC/C,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE;oBACzB,MAAM,YAAY,CAAC,MAAM,6BAAqB,CAAC;iBAChD;gBAED,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE;oBAC1B,MAAM,YAAY,CAAC,MAAM,qCAAyB,CAAC;iBACpD;gBAED,IAAI,CAAC,YAAY,CAAC,QAAQ,IAAI,CAAC,YAAY,CAAC,IAAI,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE;oBACxE,MAAM,YAAY,CAAC,MAAM,2CAA4B,CAAC;iBACvD;gBAED,IAAI,CAAC,YAAY,CAAC,WAAW,EAAE;oBAC7B,MAAM,YAAY,CAAC,MAAM,qCAAyB,CAAC;iBACpD;gBAED,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE;oBAC1B,MAAM,YAAY,CAAC,MAAM,6BAAqB,CAAC;iBAChD;gBAED,IAAI,CAAC,YAAY,CAAC,UAAU,EAAE;oBAC5B,MAAM,YAAY,CAAC,MAAM,mCAAwB,CAAC;iBACnD;gBAED,cAAc,CAAC,YAAY,CAAC,CAAC;gBAE7B,sBAAO,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,EAAC;;;KAC/B;;;;;;;;;IAUK,uCAAW,GAAjB,UAAkB,KAAa;;;;;;wBAC7B,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE;4BACnD,sBAAO,OAAO,CAAC,MAAM,CACnB,YAAY,CAAC,MAAM,mDAAgC,CACpD,EAAC;yBACH;wBAEe,qBAAM,IAAI,CAAC,wBAAwB,CAAC,KAAK,CAAC,EAAA;;wBAApD,OAAO,GAAG,SAA0C;wBAC1D,IAAI,CAAC,OAAO,EAAE;4BACZ,MAAM,YAAY,CAAC,MAAM,uDAAkC,CAAC;yBAC7D;wBAED,qBAAM,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,EAAA;;wBAAlC,SAAkC,CAAC;wBACnC,sBAAO,OAAO,EAAC;;;;KAChB;IACH,wBAAC;CAhKD,CAAuC,WAAW,GAgKjD;AAED;;;;;AAKA,SAAS,cAAc,CAAC,KAA4B;IAClD,IAAI,KAAK,CAAC,QAAQ,EAAE;QAClB,IAAI,OAAO,KAAK,CAAC,QAAQ,KAAK,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE;YACrE,MAAM,YAAY,CAAC,MAAM,6BAAqB,CAAC;SAChD;KACF;IAED,IAAI,KAAK,CAAC,OAAO,EAAE;QACjB,IAAI,OAAO,KAAK,CAAC,OAAO,KAAK,QAAQ,IAAI,KAAK,CAAC,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE;YACnE,MAAM,YAAY,CAAC,MAAM,6BAAqB,CAAC;SAChD;KACF;IAED,IAAI,KAAK,CAAC,QAAQ,EAAE;QAClB,IACE,EAAE,KAAK,CAAC,QAAQ,YAAY,UAAU,CAAC;YACvC,KAAK,CAAC,QAAQ,CAAC,MAAM,KAAK,EAAE,EAC5B;YACA,MAAM,YAAY,CAAC,MAAM,qCAAyB,CAAC;SACpD;KACF;IAED,IAAI,KAAK,CAAC,QAAQ,EAAE;QAClB,IAAI,OAAO,KAAK,CAAC,QAAQ,KAAK,QAAQ,IAAI,KAAK,CAAC,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE;YACrE,MAAM,YAAY,CAAC,MAAM,2CAA4B,CAAC;SACvD;KACF;IAED,IAAI,KAAK,CAAC,IAAI,EAAE;QACd,IAAI,EAAE,KAAK,CAAC,IAAI,YAAY,WAAW,CAAC,EAAE;YACxC,MAAM,YAAY,CAAC,MAAM,2CAA4B,CAAC;SACvD;KACF;IAED,IAAI,KAAK,CAAC,MAAM,EAAE;QAChB,IAAI,EAAE,KAAK,CAAC,MAAM,YAAY,WAAW,CAAC,EAAE;YAC1C,MAAM,YAAY,CAAC,MAAM,2CAA4B,CAAC;SACvD;KACF;IAED,IAAI,KAAK,CAAC,WAAW,EAAE;QACrB,IACE,OAAO,KAAK,CAAC,WAAW,KAAK,QAAQ;YACrC,KAAK,CAAC,WAAW,CAAC,MAAM,KAAK,CAAC,EAC9B;YACA,MAAM,YAAY,CAAC,MAAM,qCAAyB,CAAC;SACpD;KACF;IAED,IAAI,KAAK,CAAC,UAAU,EAAE;QACpB,IAAI,OAAO,KAAK,CAAC,UAAU,KAAK,QAAQ,IAAI,KAAK,CAAC,UAAU,CAAC,MAAM,KAAK,CAAC,EAAE;YACzE,MAAM,YAAY,CAAC,MAAM,mCAAwB,CAAC;SACnD;KACF;CACF;;ACpPD;;;;;;;;;;;;;;;;AAqBA,IAAM,4BAA4B,GAAG,EAAE,CAAC;AAExC;IAAuCA,6CAAW;IAAlD;QAAA,qEAyDC;QAxDoB,YAAM,GAAW,sBAAsB,CAAC;QACxC,eAAS,GAAW,CAAC,CAAC;QACtB,qBAAe,GAAW,wBAAwB,CAAC;;KAsDvE;IApDW,uCAAW,GAArB,UAAsB,OAAyB;QAC7C,IAAM,EAAE,GAAgB,OAAO,CAAC,MAAM,CAAC;QACvC,EAAE,CAAC,iBAAiB,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,OAAO,EAAE,SAAS,EAAE,CAAC,CAAC;KACpE;;;;;IAMK,+CAAmB,GAAzB,UAA0B,OAAe;;;;;;wBACvC,IAAI,OAAO,OAAO,KAAK,QAAQ,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE;4BACvD,MAAM,YAAY,CAAC,MAAM,6BAAqB,CAAC;yBAChD;wBAEc,qBAAM,IAAI,CAAC,GAAG,CAAe,OAAO,CAAC,EAAA;;wBAA9C,MAAM,GAAG,SAAqC;wBACpD,sBAAO,MAAM,GAAG,MAAM,CAAC,QAAQ,GAAG,SAAS,EAAC;;;;KAC7C;;;;IAKK,4CAAgB,GAAtB,UAAuB,OAAe,EAAE,QAAoB;;;;gBAC1D,IAAI,OAAO,OAAO,KAAK,QAAQ,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE;oBACvD,MAAM,YAAY,CAAC,MAAM,6BAAqB,CAAC;iBAChD;gBAED,IAAI,QAAQ,KAAK,IAAI,IAAI,QAAQ,CAAC,MAAM,KAAK,4BAA4B,EAAE;oBACzE,MAAM,YAAY,CAAC,MAAM,qCAAyB,CAAC;iBACpD;gBAEK,OAAO,GAAiB;oBAC5B,OAAO,SAAA;oBACP,QAAQ,UAAA;iBACT,CAAC;gBAEF,sBAAO,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,EAAC;;;KAC1B;;;;;;IAOK,8CAAkB,GAAxB,UAAyB,OAAe;;;;;4BACrB,qBAAM,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,EAAA;;wBAAlD,QAAQ,GAAG,SAAuC;wBACxD,IAAI,CAAC,QAAQ,EAAE;4BACb,MAAM,YAAY,CAAC,MAAM,uDAAkC,CAAC;yBAC7D;wBAED,qBAAM,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,EAAA;;wBAA1B,SAA0B,CAAC;wBAC3B,sBAAO,QAAQ,EAAC;;;;KACjB;IACH,wBAAC;CAzDD,CAAuC,WAAW,GAyDjD;;AChFD;;;;;;;;;;;;;;;;AAwCA,IAAM,qBAAqB,GAAG,mBAAmB,CAAC;;AAElD,AAAO,IAAM,uBAAuB,GAAG,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;AAE/D;;;;IAWE,wBAAY,GAAgB;QAA5B,iBAkBC;QAjBC,IACE,CAAC,GAAG,CAAC,OAAO,CAAC,qBAAqB,CAAC;YACnC,OAAO,GAAG,CAAC,OAAO,CAAC,qBAAqB,CAAC,KAAK,QAAQ,EACtD;YACA,MAAM,YAAY,CAAC,MAAM,qCAAyB,CAAC;SACpD;QAED,IAAI,CAAC,iBAAiB,GAAG,GAAG,CAAC,OAAO,CAAC,qBAAqB,CAAE,CAAC;QAE7D,IAAI,CAAC,iBAAiB,GAAG,IAAI,iBAAiB,EAAE,CAAC;QACjD,IAAI,CAAC,iBAAiB,GAAG,IAAI,iBAAiB,EAAE,CAAC;QACjD,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ,EAAE,CAAC;QAE/B,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;QACf,IAAI,CAAC,QAAQ,GAAG;YACd,MAAM,EAAE,cAAM,OAAA,KAAI,CAAC,MAAM,EAAE,GAAA;SAC5B,CAAC;KACH;;;;IAKK,iCAAQ,GAAd;;;;;;wBAEQ,iBAAiB,GAAG,IAAI,CAAC,0BAA0B,EAAE,CAAC;wBAC5D,IAAI,iBAAiB,KAAK,QAAQ,EAAE;4BAClC,MAAM,YAAY,CAAC,MAAM,qDAAiC,CAAC;yBAC5D;6BAAM,IAAI,iBAAiB,KAAK,SAAS,EAAE;;4BAE1C,sBAAO,IAAI,EAAC;yBACb;wBAEa,qBAAM,IAAI,CAAC,kBAAkB,EAAE,EAAA;;wBAAvC,KAAK,GAAG,SAA+B;wBACtB,qBAAM,IAAI,CAAC,kBAAkB,EAAE,EAAA;;wBAAhD,cAAc,GAAG,SAA+B;wBAG7B,qBAAM,IAAI,CAAC,mBAAmB,CACrD,KAAK,EACL,cAAc,CACf,EAAA;;wBAHK,gBAAgB,GAAG,SAGxB;wBACoB,qBAAM,IAAI,CAAC,iBAAiB,CAAC,0BAA0B,CAC1E,KAAK,CAAC,KAAK,CACZ,EAAA;;wBAFK,YAAY,GAAG,SAEpB;wBAED,IAAI,YAAY,EAAE;4BAChB,sBAAO,IAAI,CAAC,mBAAmB,CAC7B,KAAK,EACL,gBAAgB,EAChB,cAAc,EACd,YAAY,CACb,EAAC;yBACH;wBACD,sBAAO,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,gBAAgB,EAAE,cAAc,CAAC,EAAC;;;;KAClE;;;;;;;;;;IAWa,4CAAmB,GAAjC,UACE,KAAgC,EAChC,gBAAkC,EAClC,cAA0B,EAC1B,YAA0B;;;;;;wBAEpB,YAAY,GAAG,iBAAiB,CACpC,gBAAgB,EAChB,cAAc,EACd,YAAY,CACb,CAAC;wBACF,IAAI,YAAY,EAAE;4BACV,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;4BACvB,IAAI,GAAG,GAAG,YAAY,CAAC,UAAU,GAAG,uBAAuB,EAAE;gCAC3D,sBAAO,YAAY,CAAC,QAAQ,EAAC;6BAC9B;iCAAM;gCACL,sBAAO,IAAI,CAAC,WAAW,CACrB,KAAK,EACL,gBAAgB,EAChB,cAAc,EACd,YAAY,CACb,EAAC;6BACH;yBACF;;;;;wBAMD,qBAAM,IAAI,CAAC,iBAAiB,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAA;;;;;;wBAAnD,SAAmD,CAAC;wBACpD,sBAAO,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,gBAAgB,EAAE,cAAc,CAAC,EAAC;;;;KAClE;IAEa,oCAAW,GAAzB,UACE,KAAgC,EAChC,gBAAkC,EAClC,cAA0B,EAC1B,YAA0B;;;;;;;wBAGH,qBAAM,IAAI,CAAC,QAAQ,CAAC,WAAW,CAClD,IAAI,CAAC,iBAAiB,EACtB,YAAY,CAAC,QAAQ,EACrB,YAAY,CAAC,UAAU,EACvB,gBAAgB,EAChB,cAAc,CACf,EAAA;;wBANK,YAAY,GAAG,SAMpB;wBAEK,UAAU,GAAiB;4BAC/B,OAAO,EAAE,KAAK,CAAC,KAAK;4BACpB,QAAQ,EAAE,cAAc;4BACxB,WAAW,EAAE,IAAI,CAAC,iBAAiB;4BACnC,QAAQ,EAAE,YAAY;4BACtB,UAAU,EAAE,YAAY,CAAC,UAAU;4BACnC,UAAU,EAAE,IAAI,CAAC,GAAG,EAAE;4BACtB,QAAQ,EAAE,gBAAgB,CAAC,QAAQ;4BACnC,IAAI,EAAE,gBAAgB,CAAC,MAAM,CAAC,MAAM,CAAE;4BACtC,MAAM,EAAE,gBAAgB,CAAC,MAAM,CAAC,QAAQ,CAAE;yBAC3C,CAAC;wBAEF,qBAAM,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,CAAC,UAAU,CAAC,EAAA;;wBAAzD,SAAyD,CAAC;wBAC1D,qBAAM,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,CAC3C,KAAK,CAAC,KAAK,EACX,cAAc,CACf,EAAA;;wBAHD,SAGC,CAAC;wBACF,sBAAO,YAAY,EAAC;;;wBAEpB,qBAAM,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAA;;wBAA7C,SAA6C,CAAC;wBAC9C,MAAM,GAAC,CAAC;;;;;KAEX;IAEa,oCAAW,GAAzB,UACE,KAAgC,EAChC,gBAAkC,EAClC,cAA0B;;;;;4BAEL,qBAAM,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAC/C,IAAI,CAAC,iBAAiB,EACtB,gBAAgB,EAChB,cAAc,CACf,EAAA;;wBAJK,YAAY,GAAG,SAIpB;wBACK,UAAU,GAAiB;4BAC/B,OAAO,EAAE,KAAK,CAAC,KAAK;4BACpB,QAAQ,EAAE,cAAc;4BACxB,WAAW,EAAE,IAAI,CAAC,iBAAiB;4BACnC,QAAQ,EAAE,YAAY,CAAC,KAAK;4BAC5B,UAAU,EAAE,YAAY,CAAC,OAAO;4BAChC,UAAU,EAAE,IAAI,CAAC,GAAG,EAAE;4BACtB,QAAQ,EAAE,gBAAgB,CAAC,QAAQ;4BACnC,IAAI,EAAE,gBAAgB,CAAC,MAAM,CAAC,MAAM,CAAE;4BACtC,MAAM,EAAE,gBAAgB,CAAC,MAAM,CAAC,QAAQ,CAAE;yBAC3C,CAAC;wBACF,qBAAM,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,CAAC,UAAU,CAAC,EAAA;;wBAAzD,SAAyD,CAAC;wBAC1D,qBAAM,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,CAAC,KAAK,CAAC,KAAK,EAAE,cAAc,CAAC,EAAA;;wBAA1E,SAA0E,CAAC;wBAC3E,sBAAO,YAAY,CAAC,KAAK,EAAC;;;;KAC3B;;;;;;;IAQK,oCAAW,GAAjB,UAAkB,KAAa;;;;;;;oBAE7B,qBAAM,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,EAAA;;;wBAAnC,SAAmC,CAAC;wBAEf,qBAAM,IAAI,CAAC,kBAAkB,EAAE,EAAA;;wBAA9C,YAAY,GAAG,SAA+B;6BAChD,YAAY,EAAZ,wBAAY;wBACW,qBAAM,YAAY,CAAC,WAAW,CAAC,eAAe,EAAE,EAAA;;wBAAnE,gBAAgB,GAAG,SAAgD;wBACzE,IAAI,gBAAgB,EAAE;4BACpB,sBAAO,gBAAgB,CAAC,WAAW,EAAE,EAAC;yBACvC;;;;oBAGH,sBAAO,IAAI,EAAC;;;;KACb;;;;;;IAOa,0CAAiB,GAA/B,UAAgC,KAAa;;;;;4BAC3B,qBAAM,IAAI,CAAC,iBAAiB,CAAC,WAAW,CAAC,KAAK,CAAC,EAAA;;wBAAzD,OAAO,GAAG,SAA+C;wBAC/D,qBAAM,IAAI,CAAC,QAAQ,CAAC,WAAW,CAC7B,OAAO,CAAC,WAAW,EACnB,OAAO,CAAC,QAAQ,EAChB,OAAO,CAAC,UAAU,CACnB,EAAA;;wBAJD,SAIC,CAAC;;;;;KACH;;;;IAaD,4CAAmB,GAAnB,UACE,cAAyC,EACzC,cAA0B;QAE1B,OAAO,cAAc,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,IAAI,CAAC,UAAA,YAAY;YACnE,IAAI,YAAY,EAAE;gBAChB,OAAO,YAAY,CAAC;aACrB;YAED,OAAO,cAAc,CAAC,WAAW,CAAC,SAAS,CAAC;gBAC1C,eAAe,EAAE,IAAI;gBACrB,oBAAoB,EAAE,cAAc;aACrC,CAAC,CAAC;SACJ,CAAC,CAAC;KACJ;;;;;;;;IAUD,0CAAiB,GAAjB;QACE,MAAM,YAAY,CAAC,MAAM,sDAA+B,CAAC;KAC1D;IAED,yCAAgB,GAAhB,UAAiB,aAAwC;QACvD,MAAM,YAAY,CAAC,MAAM,sDAA+B,CAAC;KAC1D;IAED,0CAAiB,GAAjB,UAAkB,aAAqB;QACrC,MAAM,YAAY,CAAC,MAAM,sDAA+B,CAAC;KAC1D;IAED,kCAAS,GAAT,UACE,eAAkD,EAClD,MAAgB,EAChB,UAAuB;QAEvB,MAAM,YAAY,CAAC,MAAM,sDAA+B,CAAC;KAC1D;IAED,uCAAc,GAAd,UACE,eAAkD,EAClD,MAAgB,EAChB,UAAuB;QAEvB,MAAM,YAAY,CAAC,MAAM,sDAA+B,CAAC;KAC1D;;;;IAMD,oDAA2B,GAA3B,UAA4B,SAA2B;QACrD,MAAM,YAAY,CAAC,MAAM,8CAA2B,CAAC;KACtD;;;;;;;;;IAWK,+BAAM,GAAZ;;;;4BACE,qBAAM,OAAO,CAAC,GAAG,CAAC;4BAChB,IAAI,CAAC,iBAAiB,CAAC,aAAa,EAAE;4BACtC,IAAI,CAAC,iBAAiB,CAAC,aAAa,EAAE;yBACvC,CAAC,EAAA;;wBAHF,SAGE,CAAC;;;;;KACJ;;;;IAKD,mDAA0B,GAA1B;QACE,OAAO,YAAY,CAAC,UAAU,CAAC;KAChC;IAED,6CAAoB,GAApB;QACE,OAAO,IAAI,CAAC,iBAAiB,CAAC;KAC/B;IAED,6CAAoB,GAApB;QACE,OAAO,IAAI,CAAC,iBAAiB,CAAC;KAC/B;;;IAID,oCAAW,GAAX;QACE,OAAO,IAAI,CAAC,QAAQ,CAAC;KACtB;IACH,qBAAC;CAAA,IAAA;AAED;;;AAGA,SAAS,iBAAiB,CACxB,gBAAkC,EAClC,cAA0B,EAC1B,YAA0B;IAE1B,IACE,CAAC,YAAY,CAAC,QAAQ;QACtB,CAAC,kBAAkB,CAAC,cAAc,CAAC,MAAM,EAAE,YAAY,CAAC,QAAQ,CAAC,MAAM,CAAC,EACxE;QACA,OAAO,KAAK,CAAC;KACd;IAED,IAAM,eAAe,GAAG,gBAAgB,CAAC,QAAQ,KAAK,YAAY,CAAC,QAAQ,CAAC;IAC5E,IAAM,WAAW,GAAG,kBAAkB,CACpC,gBAAgB,CAAC,MAAM,CAAC,MAAM,CAAC,EAC/B,YAAY,CAAC,IAAI,CAClB,CAAC;IACF,IAAM,aAAa,GAAG,kBAAkB,CACtC,gBAAgB,CAAC,MAAM,CAAC,QAAQ,CAAC,EACjC,YAAY,CAAC,MAAM,CACpB,CAAC;IAEF,OAAO,eAAe,IAAI,WAAW,IAAI,aAAa,CAAC;CACxD;;ACpYD;;;;;;;;;;;;;;;;AAqCA,IAAM,OAAO,GAAG,SAAS,CAAC;AAE1B;IAAkCA,wCAAc;IAG9C,sBAAY,GAAgB;QAA5B,YACE,kBAAM,GAAG,CAAC,SAWX;QAdO,sBAAgB,GAA4B,IAAI,CAAC;QAKvD,IAAI,CAAC,gBAAgB,CAAC,MAAM,EAAE,UAAA,CAAC;YAC7B,KAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;SAChB,CAAC,CAAC;QACH,IAAI,CAAC,gBAAgB,CAAC,wBAAwB,EAAE,UAAA,CAAC;YAC/C,KAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;SACrB,CAAC,CAAC;QACH,IAAI,CAAC,gBAAgB,CAAC,mBAAmB,EAAE,UAAA,CAAC;YAC1C,KAAI,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC;SAC7B,CAAC,CAAC;;KACJ;;;IAID,6BAAM,GAAN,UAAO,KAAgB;QACrB,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC;KACtC;;;IAID,kCAAW,GAAX,UAAY,KAAkC;QAC5C,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC,CAAC;KAC3C;;;IAID,0CAAmB,GAAnB,UAAoB,KAAwB;QAC1C,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,oBAAoB,CAAC,KAAK,CAAC,CAAC,CAAC;KACnD;;;;;;;;;;;;;IAca,8BAAO,GAArB,UAAsB,KAAgB;;;;;;wBACpC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE;4BACf,sBAAO;yBACR;wBAGD,IAAI;4BACF,UAAU,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;yBAChC;wBAAC,OAAO,GAAG,EAAE;;4BAEZ,sBAAO;yBACR;wBAEyB,qBAAM,IAAI,CAAC,kBAAkB,EAAE,EAAA;;wBAAnD,iBAAiB,GAAG,SAA+B;wBACzD,IAAI,iBAAiB,EAAE;;4BAErB,sBAAO,IAAI,CAAC,2BAA2B,CAAC,UAAU,CAAC,EAAC;yBACrD;wBAEK,mBAAmB,GAAG,IAAI,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC;6BAC9D,mBAAmB,EAAnB,wBAAmB;wBACf,iBAAiB,GAAG,mBAAmB,CAAC,KAAK,IAAI,EAAE,CAAC;wBAC9C,qBAAM,IAAI,CAAC,kBAAkB,EAAE,EAAA;;wBAArC,GAAG,GAAG,SAA+B;wBAEnC,OAAO,GAAK,mBAAmB,QAAxB,CAAyB;wBAChC,UAAU,GAAK,YAAY,WAAjB,CAAkB;;wBAEpC,IAAI,OAAO,IAAI,UAAU,IAAI,OAAO,CAAC,MAAM,GAAG,UAAU,EAAE;4BACxD,OAAO,CAAC,IAAI,CACV,gCAA8B,UAAU,cAAW;gCACjD,8CAA8C,CACjD,CAAC;yBACH;wBAED,sBAAO,GAAG,CAAC,gBAAgB,CAAC,iBAAiB,EAAE,mBAAmB,CAAC,EAAC;;6BAC3D,IAAI,CAAC,gBAAgB,EAArB,wBAAqB;wBAC9B,qBAAM,IAAI,CAAC,gBAAgB,CAAC,UAAU,CAAC,EAAA;;wBAAvC,SAAuC,CAAC;wBACxC,sBAAO;;;;;KAEV;IAEa,mCAAY,GAA1B,UACE,MAAmC;;;;;;;wBAIlB,qBAAM,IAAI,CAAC,kBAAkB,EAAE,EAAA;;wBAA9C,YAAY,GAAG,SAA+B,CAAC;;;;wBAE/C,MAAM,YAAY,CAAC,MAAM,sDAAkC;4BACzD,SAAS,EAAE,KAAG;yBACf,CAAC,CAAC;;;wBAIH,qBAAM,YAAY,CAAC,WAAW,CAAC,eAAe,EAAE,EAAA;;wBAAhD,SAAgD,CAAC;;;;wBAK3C,iBAAiB,GAAG,IAAI,CAAC,oBAAoB,EAAE,CAAC;wBACjC,qBAAM,iBAAiB,CAAC,0BAA0B,CACrE,YAAY,CAAC,KAAK,CACnB,EAAA;;wBAFK,YAAY,GAAG,SAEpB;wBACD,IAAI,CAAC,YAAY,EAAE;;;4BAGjB,MAAM,KAAG,CAAC;yBACX;;wBAGD,qBAAM,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAA;;;wBAA7C,SAA6C,CAAC;wBAC9C,MAAM,KAAG,CAAC;;;;;KAEb;IAEa,2CAAoB,GAAlC,UAAmC,KAAwB;;;;;;wBACzD,IACE,CAAC,KAAK,CAAC,YAAY;4BACnB,CAAC,KAAK,CAAC,YAAY,CAAC,IAAI;4BACxB,CAAC,KAAK,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,EACjC;;4BAEA,sBAAO;yBACR;6BAAM,IAAI,KAAK,CAAC,MAAM,EAAE;;;;4BAIvB,sBAAO;yBACR;;wBAGD,KAAK,CAAC,wBAAwB,EAAE,CAAC;wBACjC,KAAK,CAAC,YAAY,CAAC,KAAK,EAAE,CAAC;wBAErB,UAAU,GAAmB,KAAK,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;wBACpE,IAAI,CAAC,UAAU,CAAC,YAAY,EAAE;;4BAE5B,sBAAO;yBACR;wBAEK,IAAI,GACR,CAAC,UAAU,CAAC,UAAU,IAAI,UAAU,CAAC,UAAU,CAAC,IAAI;4BACpD,UAAU,CAAC,YAAY,CAAC,YAAY,CAAC;wBACvC,IAAI,CAAC,IAAI,EAAE;;4BAET,sBAAO;yBACR;wBAEkB,qBAAM,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,EAAA;;wBAAhD,YAAY,GAAG,SAAiC;6BAChD,CAAC,YAAY,EAAb,wBAAa;wBAEA,qBAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,EAAA;;;wBAAlD,YAAY,GAAG,SAAmC,CAAC;;4BAEpC,qBAAM,YAAY,CAAC,KAAK,EAAE,EAAA;;wBAAzC,YAAY,GAAG,SAA0B,CAAC;;;wBAG5C,IAAI,CAAC,YAAY,EAAE;;4BAEjB,sBAAO;yBACR;;;wBAID,OAAO,UAAU,CAAC,YAAY,CAAC;wBAC/B,OAAO,UAAU,CAAC,UAAU,CAAC;wBAEvB,WAAW,GAAG,YAAY,CAC9B,WAAW,CAAC,oBAAoB,EAChC,UAAU,CACX,CAAC;;;wBAIF,sBAAO,IAAI,CAAC,uBAAuB,CAAC,YAAY,EAAE,WAAW,CAAC,EAAC;;;;KAChE;;;IAID,2CAAoB,GAApB,UACE,UAA0B;;QAE1B,IAAI,CAAC,UAAU,EAAE;YACf,OAAO;SACR;QAED,IAAI,OAAO,UAAU,CAAC,YAAY,KAAK,QAAQ,EAAE;YAC/C,OAAO;SACR;QAED,IAAM,uBAAuB,wBACxB,UAAU,CAAC,YAAY,CAC3B,CAAC;;;;;QAMF,uBAAuB,CAAC,IAAI,wBACvB,UAAU,CAAC,YAAY,CAAC,IAAI,eAC9B,OAAO,IAAG,UAAU,MACtB,CAAC;QAEF,OAAO,uBAAuB,CAAC;KAChC;;;;;;;;;;;;;;;;IAiBD,kDAA2B,GAA3B,UAA4B,QAA0B;QACpD,IAAI,CAAC,QAAQ,IAAI,OAAO,QAAQ,KAAK,UAAU,EAAE;YAC/C,MAAM,YAAY,CAAC,MAAM,mEAAwC,CAAC;SACnE;QAED,IAAI,CAAC,gBAAgB,GAAG,QAAQ,CAAC;KAClC;;;;;;;IAQK,uCAAgB,GAAtB,UAAuB,GAAW;;;;;;wBAG1B,SAAS,GAAG,IAAI,GAAG,CAAC,GAAG,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC;wBAErC,qBAAM,aAAa,EAAE,EAAA;;wBAAlC,UAAU,GAAG,SAAqB;wBAEpC,cAAc,GAAwB,IAAI,CAAC;wBAC/C,KAAS,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;4BACpC,eAAe,GAAG,IAAI,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,GAAG,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;iCACnE,IAAI,CAAC;4BACR,IAAI,eAAe,KAAK,SAAS,EAAE;gCACjC,cAAc,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC;gCAC/B,MAAM;6BACP;yBACF;wBAED,sBAAO,cAAc,EAAC;;;;KACvB;;;;;;;;;;IAWK,8CAAuB,GAA7B,UACE,MAAoB,EACpB,OAAwB;;;;;gBAIxB,IAAI,CAAC,MAAM,EAAE;oBACX,MAAM,YAAY,CAAC,MAAM,yDAAmC,CAAC;iBAC9D;gBAED,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;;;;KAC7B;;;;;;;IAQK,yCAAkB,GAAxB;;;;;4BACqB,qBAAM,aAAa,EAAE,EAAA;;wBAAlC,UAAU,GAAG,SAAqB;wBAExC,sBAAO,UAAU,CAAC,IAAI,CACpB,UAAC,MAAoB;gCACnB,OAAA,MAAM,CAAC,eAAe,KAAK,SAAS;;;oCAGpC,CAAC,MAAM,CAAC,GAAG,CAAC,UAAU,CAAC,qBAAqB,CAAC;6BAAA,CAChD,EAAC;;;;KACH;;;;;;;;;IAUK,kDAA2B,GAAjC,UAAkC,UAA0B;;;;;;4BACvC,qBAAM,aAAa,EAAE,EAAA;;wBAAlC,UAAU,GAAG,SAAqB;wBAElC,WAAW,GAAG,YAAY,CAAC,WAAW,CAAC,iBAAiB,EAAE,UAAU,CAAC,CAAC;wBAE5E,qBAAM,OAAO,CAAC,GAAG,CACf,UAAU,CAAC,GAAG,CAAC,UAAA,MAAM;gCACnB,OAAA,KAAI,CAAC,uBAAuB,CAAC,MAAM,EAAE,WAAW,CAAC;6BAAA,CAClD,CACF,EAAA;;wBAJD,SAIC,CAAC;;;;;KACH;;;;;IAMK,yCAAkB,GAAxB;;;gBACE,sBAAO,IAAI,CAAC,YAAY,EAAC;;;KAC1B;;;;;IAMK,yCAAkB,GAAxB;;;;;4BACgB,qBAAM,IAAI,CAAC,kBAAkB,EAAE,EAAA;;wBAAvC,KAAK,GAAG,SAA+B;wBAC7C,IAAI,CAAC,KAAK,EAAE;4BACV,MAAM,YAAY,CAAC,MAAM,2DAAoC,CAAC;yBAC/D;wBAE4B,qBAAM,IAAI,CAAC,oBAAoB,EAAE,CAAC,mBAAmB,CAChF,KAAK,CAAC,KAAK,CACZ,EAAA;;wBAFK,oBAAoB,GAAG,SAE5B;wBACD,IAAI,oBAAoB,IAAI,IAAI,EAAE;4BAChC,sBAAO,wBAAwB,EAAC;yBACjC;wBAED,sBAAO,oBAAoB,EAAC;;;;KAC7B;IACH,mBAAC;CA5VD,CAAkC,cAAc,GA4V/C;AAED,SAAS,aAAa;IACpB,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC;QAC3B,IAAI,EAAE,QAAQ;QACd,mBAAmB,EAAE,IAAI;;KAE1B,CAA4B,CAAC;CAC/B;AAED,SAAS,YAAY,CACnB,OAAoB,EACpB,OAAuB;;IAEvB;QACE,GAAC,gBAAgB,CAAC,WAAW,IAAG,OAAO;QACvC,GAAC,gBAAgB,CAAC,IAAI,IAAG,OAAO;WAChC;CACH;;ACrZD;;;;;;;;;;;;;;;;AAiBA,AAAO,IAAM,eAAe,GAAG,2BAA2B,CAAC;AAC3D,AAAO,IAAM,gBAAgB,GAAG,sCAAsC,CAAC;;AClBvE;;;;;;;;;;;;;;;;AA4CA;IAAsCA,4CAAc;;;;IAwBlD,0BAAY,GAAgB;QAA5B,YACE,kBAAM,GAAG,CAAC,SAGX;QA3BO,uBAAiB,GAAqC,IAAI,CAAC;QAC3D,yBAAmB,GAAsB,IAAI,CAAC;QAC9C,0BAAoB,GAAyB,IAAI,CAAC;QAElD,qBAAe,GAA4B,IAAI,CAAC;;QAEhD,0BAAoB,GAA4B,IAAI,CAAC;QAE5C,uBAAiB,GAAsBC,oBAAe,CACrE,UAAA,QAAQ;YACN,KAAI,CAAC,eAAe,GAAG,QAAQ,CAAC;SACjC,CACF,CAAC;QAEe,4BAAsB,GAAsBA,oBAAe,CAC1E,UAAA,QAAQ;YACN,KAAI,CAAC,oBAAoB,GAAG,QAAQ,CAAC;SACtC,CACF,CAAC;QAQA,KAAI,CAAC,uBAAuB,EAAE,CAAC;;KAChC;;;;;;;;;;IAWK,mCAAQ,GAAd;;;;;wBACE,IAAI,CAAC,IAAI,CAAC,oBAAoB,EAAE;4BAC9B,IAAI,CAAC,oBAAoB,GAAG,aAAa,EAAE,CAAC;yBAC7C;wBACD,qBAAM,IAAI,CAAC,oBAAoB,EAAA;;wBAA/B,SAA+B,CAAC;wBAChC,sBAAO,iBAAM,QAAQ,WAAE,EAAC;;;;KACzB;;;;;;;;;IAUK,4CAAiB,GAAvB;;;;;;wBACE,IAAI,IAAI,CAAC,0BAA0B,EAAE,KAAK,SAAS,EAAE;4BACnD,sBAAO;yBACR;wBAEwB,qBAAM,YAAY,CAAC,iBAAiB,EAAE,EAAA;;wBAAzD,gBAAgB,GAAG,SAAsC;wBAC/D,IAAI,gBAAgB,KAAK,SAAS,EAAE;4BAClC,sBAAO;yBACR;6BAAM,IAAI,gBAAgB,KAAK,QAAQ,EAAE;4BACxC,MAAM,YAAY,CAAC,MAAM,+CAA8B,CAAC;yBACzD;6BAAM;4BACL,MAAM,YAAY,CAAC,MAAM,+CAA8B,CAAC;yBACzD;;;;;KACF;;;;;;;;IASD,2CAAgB,GAAhB,UAAiB,YAAuC;QACtD,IAAI,EAAE,YAAY,YAAY,yBAAyB,CAAC,EAAE;YACxD,MAAM,YAAY,CAAC,MAAM,2DAAoC,CAAC;SAC/D;QAED,IAAI,IAAI,CAAC,iBAAiB,IAAI,IAAI,EAAE;YAClC,MAAM,YAAY,CAAC,MAAM,yDAAmC,CAAC;SAC9D;QAED,IAAI,CAAC,iBAAiB,GAAG,YAAY,CAAC;KACvC;;;;;;;IAQD,4CAAiB,GAAjB,UAAkB,SAAiB;QACjC,IAAI,OAAO,SAAS,KAAK,QAAQ,EAAE;YACjC,MAAM,YAAY,CAAC,MAAM,2DAAoC,CAAC;SAC/D;QAED,IAAI,IAAI,CAAC,mBAAmB,IAAI,IAAI,EAAE;YACpC,MAAM,YAAY,CAAC,MAAM,yEAA2C,CAAC;SACtE;QAED,IAAM,SAAS,GAAG,mBAAmB,CAAC,SAAS,CAAC,CAAC;QAEjD,IAAI,SAAS,CAAC,MAAM,KAAK,EAAE,EAAE;YAC3B,MAAM,YAAY,CAAC,MAAM,yEAAwC,CAAC;SACnE;QAED,IAAI,CAAC,mBAAmB,GAAG,SAAS,CAAC;KACtC;;;;;;;;;IAUD,oCAAS,GAAT,UACE,cAAiD,EACjD,KAAe,EACf,SAAsB;QAEtB,IAAI,OAAO,cAAc,KAAK,UAAU,EAAE;YACxC,OAAO,IAAI,CAAC,iBAAiB,CAAC,cAAc,EAAE,KAAK,EAAE,SAAS,CAAC,CAAC;SACjE;aAAM;YACL,OAAO,IAAI,CAAC,iBAAiB,CAAC,cAAc,CAAC,CAAC;SAC/C;KACF;;;;;;;;IASD,yCAAc,GAAd,UACE,cAAiD,EACjD,KAAe,EACf,SAAsB;QAEtB,IAAI,OAAO,cAAc,KAAK,UAAU,EAAE;YACxC,OAAO,IAAI,CAAC,sBAAsB,CAAC,cAAc,EAAE,KAAK,EAAE,SAAS,CAAC,CAAC;SACtE;aAAM;YACL,OAAO,IAAI,CAAC,sBAAsB,CAAC,cAAc,CAAC,CAAC;SACpD;KACF;;;;;;;;;IAUD,yDAA8B,GAA9B,UACE,YAAuC;QAEvC,IAAM,aAAa,GACjB,YAAY,CAAC,UAAU,IAAI,YAAY,CAAC,OAAO,IAAI,YAAY,CAAC,MAAM,CAAC;QAEzE,OAAO,IAAI,OAAO,CAA4B,UAAC,OAAO,EAAE,MAAM;YAC5D,IAAI,CAAC,aAAa,EAAE;;gBAElB,MAAM,CAAC,YAAY,CAAC,MAAM,mCAAwB,CAAC,CAAC;gBACpD,OAAO;aACR;;;YAGD,IAAI,aAAa,CAAC,KAAK,KAAK,WAAW,EAAE;gBACvC,OAAO,CAAC,YAAY,CAAC,CAAC;gBACtB,OAAO;aACR;YAED,IAAI,aAAa,CAAC,KAAK,KAAK,WAAW,EAAE;gBACvC,MAAM,CAAC,YAAY,CAAC,MAAM,2CAA4B,CAAC,CAAC;gBACxD,OAAO;aACR;YAED,IAAM,mBAAmB,GAAG;gBAC1B,IAAI,aAAa,CAAC,KAAK,KAAK,WAAW,EAAE;oBACvC,OAAO,CAAC,YAAY,CAAC,CAAC;iBACvB;qBAAM,IAAI,aAAa,CAAC,KAAK,KAAK,WAAW,EAAE;oBAC9C,MAAM,CAAC,YAAY,CAAC,MAAM,2CAA4B,CAAC,CAAC;iBACzD;qBAAM;;oBAEL,OAAO;iBACR;gBACD,aAAa,CAAC,mBAAmB,CAAC,aAAa,EAAE,mBAAmB,CAAC,CAAC;aACvE,CAAC;YACF,aAAa,CAAC,gBAAgB,CAAC,aAAa,EAAE,mBAAmB,CAAC,CAAC;SACpE,CAAC,CAAC;KACJ;;;;;IAMD,6CAAkB,GAAlB;QAAA,iBA+BC;QA9BC,IAAI,IAAI,CAAC,iBAAiB,EAAE;YAC1B,OAAO,IAAI,CAAC,8BAA8B,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;SACpE;;;QAID,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC;QAE9B,OAAO,SAAS,CAAC,aAAa;aAC3B,QAAQ,CAAC,eAAe,EAAE;YACzB,KAAK,EAAE,gBAAgB;SACxB,CAAC;aACD,KAAK,CAAC,UAAC,GAAU;YAChB,MAAM,YAAY,CAAC,MAAM,wEAAwC;gBAC/D,mBAAmB,EAAE,GAAG,CAAC,OAAO;aACjC,CAAC,CAAC;SACJ,CAAC;aACD,IAAI,CAAC,UAAC,YAAuC;YAC5C,OAAO,KAAI,CAAC,8BAA8B,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC;gBAC5D,KAAI,CAAC,iBAAiB,GAAG,YAAY,CAAC;;;;;gBAMtC,YAAY,CAAC,MAAM,EAAE,CAAC;gBAEtB,OAAO,YAAY,CAAC;aACrB,CAAC,CAAC;SACJ,CAAC,CAAC;KACN;;;;;IAMK,6CAAkB,GAAxB;;;gBACE,IAAI,IAAI,CAAC,mBAAmB,EAAE;oBAC5B,sBAAO,IAAI,CAAC,mBAAmB,EAAC;iBACjC;gBAED,sBAAO,wBAAwB,EAAC;;;KACjC;;;;;;;;IASD,kDAAuB,GAAvB;QAAA,iBAyBC;QAxBC,SAAS,CAAC,aAAa,CAAC,gBAAgB,CACtC,SAAS,EACT,UAAA,KAAK;YACH,IAAI,CAAC,KAAK,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,EAAE;;gBAE5D,OAAO;aACR;YAED,IAAM,iBAAiB,GAAoB,KAAK,CAAC,IAAI,CAAC;YACtD,QAAQ,iBAAiB,CAAC,gBAAgB,CAAC,WAAW,CAAC;gBACrD,KAAK,WAAW,CAAC,iBAAiB,CAAC;gBACnC,KAAK,WAAW,CAAC,oBAAoB;oBACnC,IAAM,WAAW,GAAG,iBAAiB,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC;oBAC7D,IAAI,KAAI,CAAC,eAAe,EAAE;wBACxB,KAAI,CAAC,eAAe,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;qBACxC;oBACD,MAAM;gBACR;;oBAEE,MAAM;aACT;SACF,EACD,KAAK,CACN,CAAC;KACH;IACH,uBAAC;CAzRD,CAAsC,cAAc,GAyRnD;AAED;;;;;;;AAOA,SAAsB,aAAa;;;;;;oBAC3B,WAAW,GAAG,QAAQ,CAAC,aAAa,CACxC,sBAAsB,CACvB,CAAC;oBAEF,IAAI,CAAC,WAAW,EAAE;wBAChB,sBAAO;qBACR;;;;oBAIkB,qBAAM,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,EAAA;;oBAAxC,QAAQ,GAAG,SAA6B;oBAC5B,qBAAM,QAAQ,CAAC,IAAI,EAAE,EAAA;;oBAAvC,eAAe,GAAG,SAAqB,CAAC;;;;;;oBAIxC,sBAAO;;oBAGT,IAAI,CAAC,eAAe,IAAI,CAAC,eAAe,CAAC,aAAa,EAAE;wBACtD,sBAAO;qBACR;oBAED,IAAI,eAAe,CAAC,aAAa,KAAK,cAAc,EAAE;wBACpD,MAAM,YAAY,CAAC,MAAM,yDAAmC,CAAC;qBAC9D;;;;;CACF;;ACxWD;;;;;;;;;;;;;;;;AAiBA,SAWgB,iBAAiB,CAAC,QAA4B;IAC5D,IAAM,aAAa,GAAG,WAAW,CAAC;IAElC,IAAM,aAAa,GAA2B,UAAA,GAAG;QAC/C,IAAI,CAAC,WAAW,EAAE,EAAE;YAClB,MAAM,YAAY,CAAC,MAAM,iDAA+B,CAAC;SAC1D;QAED,IAAI,IAAI,IAAI,0BAA0B,IAAI,IAAI,EAAE;;YAE9C,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,CAAC;SAC9B;aAAM;;YAEL,OAAO,IAAI,gBAAgB,CAAC,GAAG,CAAC,CAAC;SAClC;KACF,CAAC;IAEF,IAAM,gBAAgB,GAAG;QACvB,WAAW,aAAA;KACZ,CAAC;IAEF,QAAQ,CAAC,QAAQ,CAAC,eAAe,CAC/B,aAAa,EACb,aAAa,EACb,gBAAgB,CACjB,CAAC;CACH;AAED,iBAAiB,CAAC,QAA8B,CAAC,CAAC;AAiBlD,SAAgB,WAAW;IACzB,IAAI,IAAI,IAAI,0BAA0B,IAAI,IAAI,EAAE;;QAE9C,OAAO,uBAAuB,EAAE,CAAC;KAClC;SAAM;;QAEL,OAAO,2BAA2B,EAAE,CAAC;KACtC;CACF;;;;AAKD,SAAS,2BAA2B;IAClC,QACE,SAAS,CAAC,aAAa;QACvB,eAAe,IAAI,SAAS;QAC5B,aAAa,IAAI,MAAM;QACvB,cAAc,IAAI,MAAM;QACxB,OAAO,IAAI,MAAM;QACjB,yBAAyB,CAAC,SAAS,CAAC,cAAc,CAAC,kBAAkB,CAAC;QACtE,gBAAgB,CAAC,SAAS,CAAC,cAAc,CAAC,QAAQ,CAAC,EACnD;CACH;;;;AAKD,SAAS,uBAAuB;IAC9B,QACE,aAAa,IAAI,IAAI;QACrB,cAAc,IAAI,IAAI;QACtB,yBAAyB,CAAC,SAAS,CAAC,cAAc,CAAC,kBAAkB,CAAC;QACtE,gBAAgB,CAAC,SAAS,CAAC,cAAc,CAAC,QAAQ,CAAC,EACnD;CACH;;;;;"}