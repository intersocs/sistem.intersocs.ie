{"code":"/**\r\n * @license\r\n * Copyright 2019 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nimport { createInstallation } from '../api/create-installation';\r\nimport { PENDING_TIMEOUT_MS } from '../util/constants';\r\nimport { ERROR_FACTORY, isServerError } from '../util/errors';\r\nimport { sleep } from '../util/sleep';\r\nimport { generateFid, INVALID_FID } from './generate-fid';\r\nimport { remove, set, update } from './idb-manager';\r\n/**\r\n * Updates and returns the InstallationEntry from the database.\r\n * Also triggers a registration request if it is necessary and possible.\r\n */\r\nexport async function getInstallationEntry(appConfig) {\r\n    let registrationPromise;\r\n    const installationEntry = await update(appConfig, (oldEntry) => {\r\n        const installationEntry = updateOrCreateInstallationEntry(oldEntry);\r\n        const entryWithPromise = triggerRegistrationIfNecessary(appConfig, installationEntry);\r\n        registrationPromise = entryWithPromise.registrationPromise;\r\n        return entryWithPromise.installationEntry;\r\n    });\r\n    if (installationEntry.fid === INVALID_FID) {\r\n        // FID generation failed. Waiting for the FID from the server.\r\n        return { installationEntry: await registrationPromise };\r\n    }\r\n    return {\r\n        installationEntry,\r\n        registrationPromise\r\n    };\r\n}\r\nfunction updateOrCreateInstallationEntry(oldEntry) {\r\n    const entry = oldEntry || {\r\n        fid: generateFid(),\r\n        registrationStatus: 0 /* NOT_STARTED */\r\n    };\r\n    if (hasInstallationRequestTimedOut(entry)) {\r\n        return {\r\n            fid: entry.fid,\r\n            registrationStatus: 0 /* NOT_STARTED */\r\n        };\r\n    }\r\n    return entry;\r\n}\r\n/**\r\n * If the Firebase Installation is not registered yet, this will trigger the registration\r\n * and return an InProgressInstallationEntry.\r\n */\r\nfunction triggerRegistrationIfNecessary(appConfig, installationEntry) {\r\n    if (installationEntry.registrationStatus === 0 /* NOT_STARTED */) {\r\n        if (!navigator.onLine) {\r\n            // Registration required but app is offline.\r\n            const registrationPromiseWithError = Promise.reject(ERROR_FACTORY.create(\"app-offline\" /* APP_OFFLINE */));\r\n            return {\r\n                installationEntry,\r\n                registrationPromise: registrationPromiseWithError\r\n            };\r\n        }\r\n        // Try registering. Change status to IN_PROGRESS.\r\n        const inProgressEntry = {\r\n            fid: installationEntry.fid,\r\n            registrationStatus: 1 /* IN_PROGRESS */,\r\n            registrationTime: Date.now()\r\n        };\r\n        const registrationPromise = registerInstallation(appConfig, inProgressEntry);\r\n        return { installationEntry: inProgressEntry, registrationPromise };\r\n    }\r\n    else if (installationEntry.registrationStatus === 1 /* IN_PROGRESS */) {\r\n        return {\r\n            installationEntry,\r\n            registrationPromise: waitUntilFidRegistration(appConfig)\r\n        };\r\n    }\r\n    else {\r\n        return { installationEntry };\r\n    }\r\n}\r\n/** This will be executed only once for each new Firebase Installation. */\r\nasync function registerInstallation(appConfig, installationEntry) {\r\n    try {\r\n        const registeredInstallationEntry = await createInstallation(appConfig, installationEntry);\r\n        return set(appConfig, registeredInstallationEntry);\r\n    }\r\n    catch (e) {\r\n        if (isServerError(e) && e.serverCode === 409) {\r\n            // Server returned a \"FID can not be used\" error.\r\n            // Generate a new ID next time.\r\n            await remove(appConfig);\r\n        }\r\n        else {\r\n            // Registration failed. Set FID as not registered.\r\n            await set(appConfig, {\r\n                fid: installationEntry.fid,\r\n                registrationStatus: 0 /* NOT_STARTED */\r\n            });\r\n        }\r\n        throw e;\r\n    }\r\n}\r\n/** Call if FID registration is pending. */\r\nasync function waitUntilFidRegistration(appConfig) {\r\n    // Unfortunately, there is no way of reliably observing when a value in\r\n    // IndexedDB changes (yet, see https://github.com/WICG/indexed-db-observers),\r\n    // so we need to poll.\r\n    let entry = await updateInstallationRequest(appConfig);\r\n    while (entry.registrationStatus === 1 /* IN_PROGRESS */) {\r\n        // createInstallation request still in progress.\r\n        await sleep(100);\r\n        entry = await updateInstallationRequest(appConfig);\r\n    }\r\n    if (entry.registrationStatus === 0 /* NOT_STARTED */) {\r\n        throw ERROR_FACTORY.create(\"create-installation-failed\" /* CREATE_INSTALLATION_FAILED */);\r\n    }\r\n    return entry;\r\n}\r\n/**\r\n * Called only if there is a CreateInstallation request in progress.\r\n *\r\n * Updates the InstallationEntry in the DB based on the status of the\r\n * CreateInstallation request.\r\n *\r\n * Returns the updated InstallationEntry.\r\n */\r\nfunction updateInstallationRequest(appConfig) {\r\n    return update(appConfig, (oldEntry) => {\r\n        if (!oldEntry) {\r\n            throw ERROR_FACTORY.create(\"installation-not-found\" /* INSTALLATION_NOT_FOUND */);\r\n        }\r\n        if (hasInstallationRequestTimedOut(oldEntry)) {\r\n            return {\r\n                fid: oldEntry.fid,\r\n                registrationStatus: 0 /* NOT_STARTED */\r\n            };\r\n        }\r\n        return oldEntry;\r\n    });\r\n}\r\nfunction hasInstallationRequestTimedOut(installationEntry) {\r\n    return (installationEntry.registrationStatus === 1 /* IN_PROGRESS */ &&\r\n        installationEntry.registrationTime + PENDING_TIMEOUT_MS < Date.now());\r\n}\r\n//# sourceMappingURL=get-installation-entry.js.map","references":["/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/api/create-installation.ts","/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/interfaces/app-config.ts","/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/interfaces/installation-entry.ts","/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/util/constants.ts","/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/util/errors.ts","/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/util/sleep.ts","/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/helpers/generate-fid.ts","/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/helpers/idb-manager.ts"],"map":"{\"version\":3,\"file\":\"get-installation-entry.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/helpers/get-installation-entry.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/tmp/firebase-TMP/firebase-js-sdk/packages/installations/src/helpers/get-installation-entry.d.ts","writeByteOrderMark":false,"text":"/**\r\n * @license\r\n * Copyright 2019 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nimport { AppConfig } from '../interfaces/app-config';\r\nimport { InstallationEntry, RegisteredInstallationEntry } from '../interfaces/installation-entry';\r\nexport interface InstallationEntryWithRegistrationPromise {\r\n    installationEntry: InstallationEntry;\r\n    registrationPromise?: Promise<RegisteredInstallationEntry>;\r\n}\r\n/**\r\n * Updates and returns the InstallationEntry from the database.\r\n * Also triggers a registration request if it is necessary and possible.\r\n */\r\nexport declare function getInstallationEntry(appConfig: AppConfig): Promise<InstallationEntryWithRegistrationPromise>;\r\n"}}
